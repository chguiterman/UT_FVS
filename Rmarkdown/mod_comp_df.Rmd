---
title: "Growth models for Douglas fir"
author: "Courtney Giebink"
date: "October 1, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Model Selection

```{r include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(car)
library(broom.mixed)
```

load data
```{r include=FALSE}
load(file = "~/data/formatted/glmm_df_z.Rdata")
```

The current large-diameter growth model for the UT variant of FVS is a multiple regression.

* SICOND: species site index on a 50-year age basis
* ASPECT: stand aspect
* SLOPE: stand slop
* DIA_C: tree diameter at breast height
* BAL: total basal area in trees larger than the subject tree
* CR_weib: tree's live crown ratio expressed as proportion
* PCCF: crown competition factor on the subplot level
* CCF: stand crown competition factor

All the covariates above are significant in the current model for Douglas fir, except DIA_C*^2* and CCF. In the model, the response variable (dds) and diameter at breast height (DIA_C) are log transformed to linearize the relationship. Basal area of larger trees than the subject tree (BAL) and CCF are divided by 100 to encourage model convergence. Below the structure for the current model is applied to annualized data set.

```{r}
#current growth model with tree ring data (annual)
#dia^2 and ccf insignificant in current lm
lm <- lm(log(dds)~
           #tree variables
           I(log(DIA_C))+I(DIA_C^2)+
           CR_weib+I(CR_weib^2)+
           #climate
           #competition/density
           I(BAL/100)+PCCF+I(CCF/100)+
           #site variables
           SICOND+SLOPE+I(SLOPE^2)+
           I(sin(ASPECT-0.7854)*SLOPE)+
           I(cos(ASPECT-0.7854)*SLOPE),
              data = glmm_df_z)
summary(lm)$coef
```

Since there is a lot of unaccounted for variability due to individual tree and year differences, the updated model will be a mixed effects model. A random intercept on Tree ID and Year will be added to account for different baselines. A random slope on DIA_C for each year will serve as a detrending method to reduce the age effect in growth.

Covariates are standardized, or mean-centered and divided by SD, to encourage model converage, which means there is no need for BAL and CCF to be divided by 100. In addition, the log transformation on DIA_C is problematic because a log of a negative number is impossible. Therefore, the log transformation on DIA_C will be removed.

A tree's growth response is also influenced by climate, or temperature and precipitation, during the growing season. By annualizing the model with tree rings, climate can be included as a covariate. `ppt_` is the total precipitation over the following monthly range. `tmin/max_` is the average temperature over the following monthly range. Climate variables were chosen based on model AIC score, as well as ability to project into the future (e.g. `wateryr`).

```{r warning=FALSE}
#add random effects
#random intercept for each tree
#random intercept for each year
#random slope on DBH for each tree (detrending method)
an_noclim_df <- lmer(log(tdds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_weib+I(z.CR_weib^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                        data = glmm_df_z)
AIC(an_noclim_df)
#add climate
#for df, Jun is important
#previous Jun is the most correlated
#with pJun-Aug giving the best AIC
#however a specific seasonal range of precipitation might be hard to predict
#use 16mon pJun-Sep
#better AIC than wateryear
clim_1 <- lmer(log(tdds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+I(z.CR_weib^2)+
                 #climate
                 z.ppt_pJunAug+z.tmax_FebJul+ 
                 #competition/density
                 z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)
AIC(clim_1)
clim_16 <- lmer(log(tdds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+I(z.CR_weib^2)+
                 #climate
                 z.ppt_pJunSep+z.tmax_FebJul+
                 #competition/density
                 z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)
AIC(clim_16)
```

Using the full model with all the possible covariates, I will test for collinearity between predictors with the `car` package.

```{r}
vif(clim_1)
```

A Variance Inflation Factor (VIF) above 3 shows strong collinearity. There are no parameters above 3, but crown ratio (CR_weib) and basal area of trees larger than the subject tree (BAL) appear to be mildly correlated. Crown competition factor of the subplot (PCCF) and the stand (CCF) also seem to be mildly correlated.

With VIF scores below 3, the model can be reduced based on significance or importance (i.e. coeficient value).

```{r}
summary(clim_1)$coef
```

`CR_weib`*^2* can be removed based on significance. `PCCF` can be removed based on significance and suspected collinearity with `CCF`, which describes the same process: competition. Finally, `SLOPE`*^2* can be removed based on significance.

```{r warning=FALSE}
#reduce based on significance
#CR^2
#PCCF
clim_1_red <- lmer(log(tdds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+
                 #climate
                 z.ppt_pJunAug*z.tmax_FebJul+ #interaciton significant
                 #competition/density
                 z.BAL+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)
AIC(clim_1_red)

clim_16_red <- lmer(log(tdds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+
                 #climate 
                 z.ppt_pJunSep*z.tmax_FebJul+ #interaciton significant
                 #competition/density
                 z.BAL+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)

summary(clim_1_red)$coef
```

Further, we can reduce based on interpretability. `z.sin` and `z.cos` are suppose to account for the radiation received by the tree based on the aspect and slope of the site the tree is located on. However, their interpretation is inconsistent, so we will remove them.


```{r}
#reduce based on interpretability
#z.sin and z.cos
clim_1_red <- lmer(log(tdds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+
                 #climate
                 z.ppt_pJunAug*z.tmax_FebJul+ #interaciton significant
                 #competition/density
                 z.BAL+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)
AIC(clim_1_red)

clim_16_red <- lmer(log(tdds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+
                   #climate 
                 z.ppt_pJunSep*z.tmax_FebJul+ #interaciton significant
                 #competition/density
                 z.BAL+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)

summary(clim_1_red)$coef
```

Also, it may not be necessary to include two competition factors (CCF and BAL). We can reduce BAL due to its collinearity with CR.

```{r}
#reduce
#BAL
clim_1_red <- lmer(log(tdds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+
                 #climate
                 z.ppt_pJunAug*z.tmax_FebJul+ #interaciton significant
                 #competition/density
                 z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)
AIC(clim_1_red)

clim_16_red <- lmer(log(tdds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+
                 #climate 
                 z.ppt_pJunSep*z.tmax_FebJul+ #interaciton significant
                 #competition/density
                 z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)

summary(clim_1_red)$coef
```

Since transforming a variable to meet the assumptions of linearity and normality are not ideal, a generalized linear mixed model (GLMM) can be parameterized.

```{r warning=FALSE}
#gamma
glmm_g <- glmer(dds~
                  #tree variables
                  z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                  z.CR_weib+I(z.CR_weib^2)+
                  #climate
                  z.ppt_pJunAug+z.tmax_FebJul+ 
                  #competition/density
                  z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                  #site variables
                  z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                  z.sin+z.cos+
                  #random effects
                  (1+z.DIA_C|TRE_CN)+(1|Year),
                data = glmm_df_z,
                family = Gamma(link = "log"),
                glmerControl(optimizer = "bobyqa", 
                             optCtrl = list(maxfun = 100000)))
vif(glmm_g)
```

```{r}
summary(glmm_g)$coef
```

```{r}
#reduced based on signficance
#CR^2
#PCCF
#SLOPE^2
glmm_red <- glmer(dds~
                  #tree variables
                  z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                  z.CR_weib+
                  #climate
                  z.ppt_pJunAug*z.tmax_FebJul+ #interaciton significant
                  #competition/density
                  z.BAL+z.CCF+ #remove /100 due to standardization
                  #site variables
                  z.SICOND+z.SLOPE+
                  z.sin+z.cos+
                  #random effects
                  (1+z.DIA_C|TRE_CN)+(1|Year),
                data = glmm_df_z,
                family = Gamma(link = "log"),
                glmerControl(optimizer = "bobyqa", 
                             optCtrl = list(maxfun = 100000)))
summary(glmm_red)$coef
```

```{r}
#reduced based on interpretability
#z.sin and z.cos
#BAL
glmm_red <- glmer(dds~
                  #tree variables
                  z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                  z.CR_weib+
                  #climate
                  z.ppt_pJunAug*z.tmax_FebJul+ #interaciton significant
                  #competition/density
                  z.CCF+ #remove /100 due to standardization
                  #site variables
                  z.SICOND+z.SLOPE+
                  #random effects
                  (1+z.DIA_C|TRE_CN)+(1|Year),
                data = glmm_df_z,
                family = Gamma(link = "log"),
                glmerControl(optimizer = "bobyqa", 
                             optCtrl = list(maxfun = 100000)))
summary(glmm_red)$coef
```


```{r}
library(dotwhisker)
lmm_df <-  tidy(lmm_1_red) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "LMM")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_weib = "Crown Ratio",
                       z.ppt_pJunAug = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope"))
glmm_df <-  tidy(glmm_red) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "GLMM")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_weib = "Crown Ratio",
                       z.ppt_pJunAug = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope"))
models_df <- full_join(lmm_df,glmm_df)
dwplot(models_df, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  ggtitle("Growth for Douglas Fir") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
```

The Akaike's Information Criterion can be used to compare models, except between linear mixed models and generalized linear mixed models. A residual analysis will determine which model is best.

## Model Diagnostics

```{r}
#residuals
par(mfrow=c(1,2))

#lmm_1_red
resid_lmm1<- residuals(lmm_1_red,type="pearson",scaled=TRUE)
qqnorm(resid_lmm1,main="QQ plot of LMM1")
qqline(resid_lmm1)
hist(resid_lmm1)

#clim_wy_red
resid_lmmwy <- residuals(lmm_wy_red,type="pearson",scaled=TRUE)
qqnorm(resid_lmmwy,main="QQ plot of LMMwy")
qqline(resid_lmmwy)
hist(resid_lmmwy)

#To test if my transformed residuals have a constant variance with a mean of zero, 
#I will plot transformed residuals vs predicted values.
library(gplots)
par(mfrow=c(1,1))
pred_lmm1 <- predict(lmm_1_red, type="response")
plotLowess(resid_lmm1~pred_lmm1, ylab="Residuals",xlab="Predicted", main="LMM1")

par(mfrow=c(1,2))
plotLowess(resid_lmm1~z.DIA_C,data = glmm_df_z,ylab="Residuals",main="LMM1")
plotLowess(resid_lmm1~z.CR_weib,data = glmm_df_z,ylab="Residuals",main="LMM1")
plotLowess(resid_lmm1~z.ppt_pJunAug,data = glmm_df_z,ylab="Residuals",main="LMM1") 
plotLowess(resid_lmm1~z.tmax_FebJul,data = glmm_df_z,ylab="Residuals",main="LMM1")
plotLowess(resid_lmm1~z.CCF,data = glmm_df_z,ylab="Residuals",main="LMM1")
plotLowess(resid_lmm1~z.SICOND,data = glmm_df_z,ylab="Residuals",main="LMM1")
plotLowess(resid_lmm1~z.SLOPE,data = glmm_df_z,ylab="Residuals",main="LMM1")
```

```{r}
#pearson not correct for GLMM
library(DHARMa)
res <- simulateResiduals(fittedModel = glmm_red)
plot(res)
#res_tre <- recalculateResiduals(res, group = glmm_df_z$TRE_CN)
#plot(res_tre, quantreg = FALSE)
#testTemporalAutocorrelation(res_tre, time = glmm_df_z$Year)
#testTemporalAutocorrelation(res_tre)
#grouping not working
testUniformity(res)
res_glmm <- res$scaledResiduals
hist(res_glmm)

resid_glmm <- residuals(glmm_red,type="pearson",scaled=TRUE)
qqnorm(resid_glmm,main="QQ plot of GLMM1")
qqline(resid_glmm)
pred_glmm <- predict(glmm_red, type="response")

plotLowess(resid_glmm~pred_glmm, ylab="Residuals",xlab="Predicted", main="GLMM")
plotLowess(resid_glmm~z.DIA_C,data = glmm_df_z,ylab="Residuals",main="GLMM")
plotLowess(resid_glmm~z.CR_weib,data = glmm_df_z,ylab="Residuals",main="GLMM")
plotLowess(resid_glmm~z.ppt_pAugOct,data = glmm_df_z,ylab="Residuals",main="GLMM") #still heteroskedasticity
plotLowess(resid_glmm~z.tmax_JunAug,data = glmm_df_z,ylab="Residuals",main="GLMM")
plotLowess(resid_glmm~z.CCF,data = glmm_df_z,ylab="Residuals",main="GLMM")
plotLowess(resid_glmm~z.SICOND,data = glmm_df_z,ylab="Residuals",main="GLMM")
plotLowess(resid_glmm~z.SLOPE,data = glmm_df_z,ylab="Residuals",main="GLMM")
```

## Interpretation

After a model is chosen.

```{r include=FALSE}
#library(effects)
```

