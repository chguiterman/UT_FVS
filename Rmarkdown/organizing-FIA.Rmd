---
title: "Organizing FIA Data"
author: "Margaret Evans and Courtney Giebink"
date: "December 20, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Objective

Climate and site data from the U. S. Forest Service's Forest Inventory and Analysis (FIA) program needs to be organized to fit a generalized linear mixed model. We will filter for trees with both tree ring and diameter measurements. In addition, we will separate the tree ring widths, temperature, and precipitation columns. Each row in the resulting dataframe will have a tree ring width that corresponds to an individual tree and year with climate and site varbiables. Data organizing will be accomplished using the [tidyr](https://cran.r-project.org/web/packages/tidyr/tidyr.pdf) package.

```{r include=FALSE}
library(tidyr)
AZ.PIPO <- read.delim("AZ_FIA_RWL_PRISM_allinone_04192017.txt", stringsAsFactors = F)
```

## Selecting trees with all the necessary data

First, merge together three diameter columns in the original FIA dataset. The first line will combine together FIA database diameter measurements for trees and site trees. The second line will replace missing data with diameter at breast height (DBH) recorded from core mounts.

```{r}
AZ.PIPO$DIA <- ifelse(is.na(AZ.PIPO$TREE_DIA), AZ.PIPO$SITETREE_DIA, AZ.PIPO$TREE_DIA)
AZ.PIPO$DIA <- ifelse(is.na(AZ.PIPO$DIA), AZ.PIPO$DBH, AZ.PIPO$DIA)
```

Next, cases in which data is missing must be filtered out. We will remove trees in which there is no size information, or diameter is NA. We will also remove trees where covariate data, such as site index and stand density, are missing.

```{r}
AZ.PIPO <- AZ.PIPO[!is.na(AZ.PIPO$DIA),]
AZ.PIPO <- AZ.PIPO[!is.na(AZ.PIPO$COND_SICOND),]
AZ.PIPO <- AZ.PIPO[!is.na(AZ.PIPO$SDI),]
```

In a minority of cases, the difference between measure year and end date is not 0 or 1. Anything other than 0 or 1 will be filtered out. 

```{r}
temp1 <- AZ.PIPO[AZ.PIPO$PLOT_MEASYEAR-AZ.PIPO$DateEnd<2,]
temp2 <- temp1[temp1$PLOT_MEASYEAR-temp1$DateEnd>-1,]
```

```{r include=FALSE}
save(temp2,file = "temp2")
```

```{r include=FALSE}
numtrees <- nrow(temp2)
```

The resulting dataframe has `r numtrees` trees.

##Separating tree ring widths

Tree ring widths are in a column, separated by a comma. We will make a new dataframe of tree ring widths where each row is the tree sampled and each column is the year of growth. Widths will be taken from temp2, so there will be `r numtrees` trees. Years will start at the first year of tree ring measurements, which is 1719, and will end at the last year of tree ring measurements, which is 2010. Therefore, there will be 292 years, or columns.

```{r}
temp2$Widths <- as.character(temp2$Widths)
first.start.yr <- min(temp2$DateFirst, na.rm=T)
last.DBH.yr.1 <- max(temp2$T2_MEASYR, na.rm=T)
last.DBH.yr.2 <- 1900 
last.meas.yr <- max(last.DBH.yr.1, last.DBH.yr.2)
years <- seq(first.start.yr, last.meas.yr)
y.matrix <- matrix(data=NA, nrow=nrow(temp2), ncol=length(years))
colnames(y.matrix) <- years
for (t in 1:nrow(temp2)) {
  width.string <- temp2$Widths[t]
  width.vector <- as.numeric(unlist(strsplit(x = width.string, split = ",")))
  start.column <- which(years == temp2$DateFirst[t])
  end.column <- which(years == temp2$DateEnd[t])
  width.subset <- (end.column - start.column) + 1
  width.vector <- width.vector[1:width.subset] 
  width.vector <- width.vector*0.1*2 # convert to cm 
  #and multiply by 2 to turn radial increment into diameter increment
  y.matrix[t, c(start.column:end.column)] <- width.vector 
  # put vector in y.matrix at the right start year:end year
}
```

```{r echo=FALSE}
y.matrix[248:252,210:216]
```

```{r include=FALSE}
save(y.matrix, file = "y.matrix")
```

The resulting dataframe of tree ring widths must be truncated so that the first year of the dataframe is 1966.

```{r}
trunc.yr = 1966
index.last.start <- which(years==trunc.yr) 
y.small <- y.matrix[,index.last.start:ncol(y.matrix)]
years.small <- years[index.last.start:ncol(y.matrix)]
z0 <- matrix(data=NA, nrow=nrow(y.small), ncol=ncol(y.small))
```



```{r}
DIA.T1 <- vector(mode="numeric", length=nrow(temp2))
ave.ring <- vector(mode="numeric", length=nrow(temp2))
for (t in 1:nrow(temp2)) {
  ### shrink tree backward: subtract the cumulative tree-ring-derived diameter increments (in y.matrix) from DIA
  ifelse(!is.na(temp2$DIA[t]), DIA.T1[t]<-temp2$DIA[t]*2.54, DIA.T1[t]<-NA) # extract time 1 DBH (in some cases, the only DBH measurement)
  # extract tree-ring data from trunc.yr:end series
  end.col <- which(years==temp2$DateEnd[t])
  temp.growth <- y.matrix[t,(index.last.start+1):end.col] # which(years==1966) # returns 248
  # add rep(ave.ring) to any NA's at the beginning of the tree-ring time series
  ave.ring[t] <- mean(temp.growth, na.rm=T)
  temp.growth[is.na(temp.growth)]<-ave.ring[t]
  temp.growth2 <- c(-rev(cumsum(rev(temp.growth))),0) # add a zero at the end of this so that z0 in MEASYR = DIA
  z0[t,1:length(temp.growth2)] <- DIA.T1[t] + temp.growth2 # note that this is one year off where DateEnd = MEASYEAR-1
  
  ### grow tree forward: find short-term average ring-width per tree and add cumulative from DIA to year 2010
  ave.growth <- rep(ave.ring[t], times=(last.meas.yr-temp2$DateEnd[t]))
  z0[t, (length(temp.growth2)+1):length(years.small)] <- DIA.T1[t] + cumsum(ave.growth)
}
```


##Separating climate data

Like tree ring widths, monthly climate data, including total precipitation, maximum temperature and minimum temperature, are in a column, separated by a comma. We will make a large list of monthly climate variables for each tree and year. Again, there are `r numtrees` trees. However, since we truncated the data, there are 45 years (1966 - 2010).

```{r}
PRISM.years <- seq(from=1895, to=2015) #length = 121
index.start.climate <- which(PRISM.years == trunc.yr)
index.end.climate <- index.start.climate+(last.meas.yr-trunc.yr)
PRISM.ncol <- (last.meas.yr-trunc.yr)+1 
```

```{r}
# first, build an object that has the PRISM strings for both trees with and without cores
climate.names <- c("PPTJan", "PPTFeb", "PPTMar", "PPTApr", "PPTMay", "PPTJun",
                   "PPTJul", "PPTAug", "PPTSep", "PPTOct", "PPTNov", "PPTDec",
                   "TMINJan", "TMINFeb", "TMINMar", "TMINApr", "TMINMay", "TMINJun",
                   "TMINJul", "TMINAug", "TMINSep", "TMINOct", "TMINNov", "TMINDec",
                   "TMAXJan", "TMAXFeb", "TMAXMar", "TMAXApr", "TMAXMay", "TMAXJun",
                   "TMAXJul", "TMAXAug", "TMAXSep", "TMAXOct", "TMAXNov", "TMAXDec")
PRISM.strings <- temp2[climate.names]

# which climate variables should be taken from year t and which from year t-1?
yrt.clim.var <- c("PPTJan", "PPTFeb", "PPTMar", "PPTApr", "PPTMay", "PPTJun",
                  "PPTJul", "PPTAug", "TMAXJan", "TMAXFeb", "TMAXMar", "TMAXApr",
                  "TMAXMay","TMAXJun", "TMAXJul","TMAXAug", "TMINJan","TMINFeb", 
                  "TMINMar","TMINApr","TMINMay", "TMINJun", "TMINJul", "TMINAug")
yrt_1.clim.var <- c("PPTSep", "PPTOct", "PPTNov", "PPTDec", "TMAXSep", "TMAXOct",
                    "TMAXNov","TMAXDec","TMINSep","TMINOct","TMINNov", "TMINDec")
names.clim.var <- c(yrt.clim.var, yrt_1.clim.var)
```

```{r}
time_data <- list() # make empty list;
#12 items (climate variables), each with rows as trees and years as columns

counter <- 1
for (i in yrt.clim.var) { ## climate variables taken from year t, current Jan-Aug
  tmp.matrix <- matrix(nrow = nrow(PRISM.strings), ncol = PRISM.ncol) 
  # should have 544 + 14,155 rows
  for (j in 1:nrow(PRISM.strings)) {
    tmp <- as.numeric(unlist(strsplit(PRISM.strings[j,i], split = ",")))
    tmp <- tmp[index.start.climate:index.end.climate]
    # subset tmp to only contain years of interest (trunc.yr-2015)
    tmp.matrix[j,] <- tmp
  }
  # Put the matrix into the list
  time_data[[counter]] <- tmp.matrix 
  # use 1 here instead of counter for a single climate variable
  counter <- counter + 1
}

for (i in yrt_1.clim.var) { ##climate variables taken from year t-1, i.e., previous Sept-Dec
  tmp.matrix <- matrix(nrow = nrow(PRISM.strings), ncol = PRISM.ncol)
  for (j in 1:nrow(PRISM.strings)) {
    tmp <- as.numeric(unlist(strsplit(PRISM.strings[j,i], split = ",")))
    tmp <- tmp[(index.start.climate-1):(index.end.climate-1)]
    # subset tmp to only contain years of interest (1971-2009)
    tmp.matrix[j,] <- tmp
  }
  time_data[[counter]] <- tmp.matrix 
  # use 2 here instead of counter for a single climate variable
  counter <- counter + 1
}

# Assign the climate variable names to the list (named list)
names(time_data) <- names.clim.var
```



```{r}
# calculate winter precip and add to the list time_data (rows are trees, columns are years)
wintP.wateryr <- (time_data$PPTSep + time_data$PPTOct + time_data$PPTNov + time_data$PPTDec +
                    time_data$PPTJan + time_data$PPTFeb + time_data$PPTMar + time_data$PPTApr +
                    time_data$PPTMay + time_data$PPTJun + time_data$PPTJul + time_data$PPTAug)
wintP.NovMar <- (time_data$PPTNov + time_data$PPTDec + time_data$PPTJan + time_data$PPTFeb + 
                   time_data$PPTMar)
wintP.OctMar <- (time_data$PPTOct + time_data$PPTNov + time_data$PPTDec + time_data$PPTJan +
                   time_data$PPTFeb + time_data$PPTMar)
wintP.DecFeb <- (time_data$PPTDec + time_data$PPTJan + time_data$PPTFeb)
wintP.JanJul <- (time_data$PPTJan + time_data$PPTFeb + time_data$PPTMar + time_data$PPTApr +
                   time_data$PPTMay + time_data$PPTJun + time_data$PPTJul)
summP.JunSept <- (time_data$PPTJun + time_data$PPTJul + time_data$PPTAug + time_data$PPTSep)
time_data$wintP.wateryr <- wintP.wateryr
time_data$wintP.NovMar <- wintP.NovMar
time_data$wintP.OctMar <- wintP.OctMar
time_data$wintP.DecFeb <- wintP.DecFeb
time_data$wintP.JanJul <- wintP.JanJul
time_data$summP.JunSept <- summP.JunSept
```



```{r}
# seasonal Tmax variables
tmax.JanA <- (time_data$TMAXJan + time_data$TMAXFeb + time_data$TMAXMar + time_data$TMAXApr +
                time_data$TMAXMay + time_data$TMAXJun + time_data$TMAXJul + time_data$TMAXAug)/8
tmax.MJul <- (time_data$TMAXMay + time_data$TMAXJun + time_data$TMAXJul)/3
time_data$tmax.JanA <- tmax.JanA
time_data$tmax.MJul <- tmax.MJul

#Tmin
tmin.DecFeb <- (time_data$TMINDec + time_data$TMINJan + time_data$TMINFeb)/3
time_data$tmin.DecFeb <-tmin.DecFeb
```



```{r}
y.long <- gather(data = as.data.frame(y.small), 
                 key = year, value = y.small.value)
z.long <- gather(data = as.data.frame(z0), 
                 key = year, value = z0.value)
wintP.long <- gather(data = as.data.frame(time_data$wintP.JJ), 
                     key = year, value = wintP.JJ.value)

wintP.long1 <- gather(data = as.data.frame(time_data$wintP.wateryr), 
                      key = year, value = wintP.JJ.value)
wintP.long2<- gather(data = as.data.frame(time_data$wintP.NovMar), 
                     key = year, value = wintP.JJ.value)
wintP.long3<- gather(data = as.data.frame(time_data$wintP.OctMar), 
                     key = year, value = wintP.JJ.value)
wintP.long4<- gather(data = as.data.frame(time_data$wintP.DecFeb), 
                     key = year, value = wintP.JJ.value)
wintP.long5<- gather(data = as.data.frame(time_data$wintP.JanJul), 
                     key = year, value = wintP.JJ.value)
wintP.long6<- gather(data = as.data.frame(time_data$summP.JunSept), 
                     key = year, value = wintP.JJ.value)

tmax.long1<- gather(data = as.data.frame(time_data$tmax.JanA), 
                    key = year, value = tmax.JanA.value)
tmax.long2<- gather(data = as.data.frame(time_data$tmax.MJul), 
                    key = year, value = tmax.MJul.value)

tmin.long1 <- gather(data = as.data.frame(time_data$tmin.DecFeb), 
                     key = year, value = tmin.DecFeb.value)
```

##Making the data frame

Once the tree-ring widths and climate data from the original dataset are separated, they can be formatted into a new data frame to fit a generalized linear mixed model. The model also includes site variables.

```{r}
SICOND <- temp2$COND_SICOND
SDI <- temp2$SDI
```

Climate variables in the dataframe will change based on traditional dendrochronology analyses.

```{r}
glmm.data <- data.frame(tree = rep(x = c(1:nrow(temp2)), times = length(years.small)), 
                        year = rep(trunc.yr:last.meas.yr, each = nrow(temp2)),
                        incr = y.long$y.small.value,
                        dbh = z.long$z0.value,
                        sdi = rep(SDI, length(years.small)),
                        si = rep(SICOND, length(years.small)),
                        PPTwateryear = wintP.long1$wintP.JJ.value,
                        PPTNovMar = wintP.long2$wintP.JJ.value,
                        PPTJunSept = wintP.long6$wintP.JJ.value,
                        TMINDecFeb = tmin.long1$tmin.DecFeb.value,
                        TMAXJanA = tmax.long1$tmax.JanA.value,
                        TMAXMJul = tmax.long2$tmax.MJul.value)
```

```{r echo=FALSE}
head(glmm.data)
```

