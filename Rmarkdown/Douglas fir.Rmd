---
title: "Linear Mixed Model for Douglas Fir"
author: "Courtney Giebink"
date: "July 31, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
```

## Data Summary

```{r include=FALSE}
load(file = '/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_data_df.Rdata')
load(file = '/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/data_all_df.Rdata')
```

My data comes from the U. S. Forest Service's Interior West - Forest Inventory and Analysis (IW-FIA) program (DeRose, Shaw, and Long 2017). The U.S. Forest Service’s Forest Inventory and Analysis program has established plots across the nation, which they use to collect data on forest stands. Recently, tree rings associated with plots in the Interior West states were discovered in storage. The IW-FIA program merged these two data sources: inventory data and tree-ring data. The data that I will use for my analysis is inventory and tree-ring data for *Pseudotsuga menziesii* (Douglas fir) in Utah. 

```{r echo=FALSE, message=FALSE}
library(maps)
m = map_data('state', region = 'Utah')

ggplot() + 
  geom_polygon( data=m, aes(x=long, y=lat,group=group),colour="black", fill="white" )+
  geom_point(data=data_all_df,aes(x=LON,y=LAT),colour="red")+
  ggtitle("Distribution of Douglas fir")+
  xlab('Longitude')+
  ylab('Latitude')+
  coord_fixed()
```


I was able to extract and calculate annual data for 59 trees between the years of 1958 and 1995. 

```{r eval=FALSE}
#create new dataframe with only variables needed for model
#response: RW, dds
#fixed: SI, ASP, SL, DBH/DIA_C, BAL, CR, CCF, PCCF, climate
#random: TRE_CN, Year
#filter for last 30 years of growth
min(data_all_df$MEASYEAR) #1988 -> 1958

glmm_data_df <- data_all_df %>%
  ungroup() %>%
  dplyr::select(PLT_CN, TRE_CN, RW, dds, Year, DIA_C, LAT,
         SICOND, ASPECT, tASPECT, SLOPE, BAL, CR, CR_weib, PCCF, CCF, cos, sin,
         ppt_pOct, ppt_pDec, ppt_Jun, ppt_Jul,
         ppt_pJunAug, ppt_pAugOct, ppt_MayJul,
         ppt_pJunNov, ppt_FebJul, wateryr, ppt_pJunSep,
         tmin_Feb, tmax_Jul,
         tmax_JunAug, tmax_pJulSep, tmin_JanMar,
         tmax_JanJun,tmin_JanJun,tmax_FebJul) %>%
  filter(Year >= 1958)

#climate
#total ppt
#1 month: pOct,pDec, Jun, Jul
#3 month: pJun-pAug, pAug-pOct, May-Jul
#6 month + : pNov, Jul, wateryr

#average temp
#1 month: Feb tmin, Jul tmax
#3 month: tmax_Jun-Aug, tmax_pJul-pSep, tmin_Jan-Mar
#6 month + : Jun, Jul
```

My data, `glmm_data_df`, consists of raw radial increment, or ring width value, (`RW`) in mm and annual change in squared inside bark diameter (dds) in inches^2 with corresponding tree, climate, and site variables. Some variables stay constant, such as site index (`SICOND`), aspect (`ASPECT`), and slope (`SLOPE`), while diameter at breast height (`DIA_C`) and crown ratio (CR, CR_weib) vary annually. In addition, density variables, being basal area of trees larger than the subject tree (`BAL`), crown competition factor on the inventory point (`PCCF`), and stand crown competition factor (`CCF`), vary annually. Significant seasonal precipitation and temperature variables were identified based on tradition dendro analysis tools, using R packages `dplR` and `treeclim` (see `Climate-growth.Rmd`)

## Exploration

It is necessary to explore the dataset to determine if the data complies with model assumptions (Zuur, Ieno, and Elphick 2010).

### Normality

The response variable, annual change in squared inside bark diameter (DDS), is continuous. It will be explained using a linear mixed model.

```{r}
par(mfrow=c(2,2))
hist(glmm_data_df$RW,breaks = 50, 
     main = "Histogram of RW (mm)", xlab = "Increment")
hist(glmm_data_df$tdds,breaks = 100,
     main = "Histogram of DDS (in^2)", xlab = "Increment")
hist(log(glmm_data_df$tdds),breaks = 100, 
     main = "Histogram of log(DDS)", xlab = "Increment")
```

The distribution of DDS is skewed right, similarly to the distribution of raw radial increment (RW). The Gamma distribution is often used for skewed data, although Gaussian might still be appropriate and easier to interpret. 

```{r}
#Cleveland dotplot
par(mfrow=c(1,2))
dotchart(glmm_data_df$tdds)
dotchart(log(glmm_data_df$tdds))
```

A log transformation normalizes the distribution of DDS and gets rid of outliers.

### Zeros and Missing Data

There is one missing ring (RW = 0) in the data set. To avoid adding an arbitrarily small number, such as 0.001, to every value in the dataset, we replaced missing rings with the smallest ring width value on the same core. 

There is also 2 trees that have NA values for `SICOND` and several trees that have NA values for `ASPECT`. Trees missing `SICOND` were removed from the analysis. Missing `ASPECT` values were changed to 0.

```{r}
which(glmm_data_df$RW == 0) #missing rings
which(is.na(glmm_data_df$RW))
which(glmm_data_df$tdds ==0)

range_df <- glmm_data_df %>%
  select(TRE_CN,Year) %>%
  group_by(TRE_CN) %>%
  summarise(minyr = min(Year),
            maxyr = max(Year))%>%
  gather("stat","year",-TRE_CN)
ggplot(range_df, aes(year, as.character(TRE_CN))) +
        geom_point(aes(color = stat)) +
   theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  ylab("TRE_CN")
```

My data is unbalanced. Almost all trees have a growth measurement for 1958, but one tree's growth measurements start several years later. In addition, most trees end growth in 1992, but some end in 1993, 1994, or 1995. There are no missing data in between first and last year of growth for each tree, and there are no years of zero growth, indicating a missing ring.

### Random and Fixed Effects

In the linear mixed effects model, tree, stand, and climate variables will be fixed effects and a tree identifier and year of growth will be random effects.

```{r}
length(unique(glmm_data_df$TRE_CN))
length(unique(glmm_data_df$PLT_CN))
```

There are almost as many unique plots as unique trees, so it is not necessary to have plots as a random effect as well.

Tree ID and year are appropriate random effects because selected trees and years are a subset from all the possible selected trees and years (Harrison et al. 2018). Each tree has its own intercept of growth due to factors not considered here, such as genetics, microclimate, etc. Each year has its own intercept of growth due to relatively good or poor conditions not accounted for in temperature and precipitation, such as cloud cover, vapor pressure deficit, etc. Each tree and year might also have its own slope, but convergence on a random slope effect can only occur with an adequate amount of data.

```{r warning=FALSE}
#understanding random effects: TRE_CN
growth_yr_plots_df <- glmm_data_df %>% 
  group_by(TRE_CN) %>%
  do(plots=ggplot(data=.) +
       aes(x=Year, y=RW) + geom_point() + 
       ggtitle(unique(.$TRE_CN)))

par(mfrow=c(2,2))
growth_yr_plots_df$plots[[1]]
growth_yr_plots_df$plots[[2]]
growth_yr_plots_df$plots[[3]]
growth_yr_plots_df$plots[[4]]
#can do more all the way to tree 59
```

```{r warning=FALSE}
#understanding random effects: Year
growth_wateryr_plots_df <- glmm_data_df %>% 
  group_by(Year) %>%
  do(plots=ggplot(data=.) +
       aes(x=wateryr, y=RW) + geom_point() +
       geom_smooth(method = "lm") + ggtitle(unique(.$Year)))

par(mfrow=c(2,2))
growth_wateryr_plots_df$plots[[8]]
growth_wateryr_plots_df$plots[[15]]
growth_wateryr_plots_df$plots[[22]]
growth_wateryr_plots_df$plots[[29]]
#can all years 1958 - 1995
```

A proxy for age (time) is diameter at breast height, which is continuous. As a tree gets older, it grows, puts on biomass, and increases its diameter. While a tree could put on the same amount of biomass each year, the biomass will be stretched over an increasing larger circumference. As such, diameter increment decays as a tree ages, or as diameter at breast height increases. This age trend has been clearly described in tree-ring science. Below is a plot of age (dbh) by my response (incr), which is fit with a linear trend:

```{r}
par(mfrow=c(2,2))
#detrend
ggplot(data = glmm_data_df, aes(x = DIA_C, y = RW)) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

ggplot(data = glmm_data_df, aes(x = DIA_C, y = tdds)) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
#non constant variance

ggplot(data = glmm_data_df, aes(x = DIA_C, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

#log to reduce heteroscedasticity
ggplot(data = glmm_data_df, aes(x = log(DIA_C), y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
#negative relationship
```

Site index is a measure of site quality. It is the estimated height in feet of a tree on the site at a specific age (FIA Database Description and User Guide for Phase 2).

```{r}
ggplot(data = glmm_data_df, aes(x = SICOND, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a postive relationship between growth and site index, meaning growth increases with increasing site quality. There is also relatively constant variance.

Slope is an estimated average at the subplot level, or condition level (FIA Database Description and User Guide for Phase 2).

```{r}
ggplot(data = glmm_data_df, aes(x = SLOPE, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and slope, meaning growth decreases with increasing slope. There is also relatively constant variance.

Basal area of trees larger than the subject tree (BAL) is a calculated covariate at the plot level.

```{r}
ggplot(data = glmm_data_df, aes(x = BAL, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and BAL, and there is decreasing variance.

Crown competition factor is a measure of stand density (Krajicek et al. 1961). Tree values of CCF estimate the percentage of an acre that would be covered by the tree’s crown if the tree were open grown (Dixon 2002). 

Crown competitition factor on the inventory point where the tree is established (PCCF) is a calculated covariate on the plot level.

```{r}
ggplot(data = glmm_data_df, aes(x = PCCF, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and PCCF, and there is relatively constant variance.

Stand crown competition factor (CCF) is a calculated covariate on the plot level. It is a summation of PCCF on the plot.

```{r}
ggplot(data = glmm_data_df, aes(x = CCF, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and CCF. In addition, there is most likely an outlier in the dataset.

Crown ratio (CR/CR_weib) is the percentage of the length of the tree with healthy foliage (FIA Database Description and User Guide for Phase 2). CR was extracted from the FIA Database for the measure year and copied backwards. CR_weib was back calculated using the Weibull distribution (Dixon 1985) on a plot level.

```{r}
ggplot(data = glmm_data_df, aes(x = CR, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

ggplot(data = glmm_data_df, aes(x = CR_weib, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a positive relationship between growth and CR and relatively constant variance. However, there is a negative relationship between growth and CR_weib.

Based on the exploration, I will transform the response variable (dds) satisfy assumptions of normality of the response variable. I will also further explore outliers with Cleveland dotplots. Normality and homogeneity will be further checked using the residuals of the final models.


## Model Building

```{r include=FALSE}
library(lme4)
library(lmerTest)
#library(nlme)
#library(glmmTMB)
```

```{r include=FALSE}
load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_df_z.Rdata")
```

The current large-diameter growth model for the UT variant of FVS is a multiple regression.

* SICOND: species site index on a 50-year age basis
* ASPECT: stand aspect
* SLOPE: stand slop
* DIA_C: tree diameter at breast height
* BAL: total basal area in trees larger than the subject tree
* CR_weib: tree's live crown ratio expressed as proportion
* PCCF: crown competition factor on the subplot level
* CCF: stand crown competition factor

All the covariates above are significant in the current model for Douglas fir, except DIA_C*^2* and CCF. In the model, the response variable (dds) and diameter at breast height (DIA_C) are log transformed to linearize the relationship. Basal area of larger trees than the subject tree (BAL) and CCF are divided by 100 to encourage model convergence. Below the structure for the current model is applied to annualized data set.

```{r eval=FALSE}
#current growth model with tree ring data (annual)
#dia^2 and ccf insignificant in current lm
lm_df <- lm(log(dds)~
           #tree variables
           I(log(DIA_C))+I(DIA_C^2)+
           CR_weib+I(CR_weib^2)+
           #climate
           #competition/density
           I(BAL/100)+PCCF+I(CCF/100)+
           #site variables
           SICOND+SLOPE+I(SLOPE^2)+
           I(sin(ASPECT-0.7854)*SLOPE)+
           I(cos(ASPECT-0.7854)*SLOPE),
              data = glmm_df_z)
```

Since there is a lot of unaccounted for variability due to individual tree and year differences, the updated model will be a mixed effects model. A random intercept on Tree ID and Year will be added to account for different baselines. A random slope on DIA_C for each year will serve as a detrending method to reduce the age effect in growth.

For now, I will use `lme4` to fit models. To fit a covariance-variance structure other than compound symmetry, I can use `nlme`. I may also explore the model fit options with `glmmTMB`.

Covariates are standardized, or mean-centered and divided by SD, to encourage model converage, which means there is no need for BAL and CCF to be divided by 100. In addition, the log transformation on DIA_C is problematic because a log of a negative number is impossible. Therefore, the log transformation on DIA_C will be removed.

# Annual Model of Tree Growth

```{r}
#add random effects
#random intercept for each tree
#random intercept for each year
#random slope on DBH for each tree (detrending method)
annual_df <- lmer(log(tdds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_weib+I(z.CR_weib^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                        data = glmm_df_z)
AIC(annual_df)
```

## Model Selection

### Collinearity

Using the full model with all the possile covariates, I will test for collinearity between predictors with the `car` package.

```{r echo=FALSE, warning=FALSE,message=FALSE}
library(car)
```

```{r}
vif(annual_df)
```

A Variance Inflation Factor (VIF) above 3 shows strong collinearity. There are no parameters above 3, but crown ratio (CR_weib) and basal area of trees larger than the subject tree (BAL) appear to be mildly correlated. Crown competition factor of the subplot (PCCF) and the stand (CCF) also seem to be mildly correlated.

With VIF scores below 3, the model can be reduced based on significance or importance (i.e. coeficient value).

```{r}
summary(annual_df)$coef
```

`CR_weib`*^2* can be removed based on significance. `PCCF` can be removed based on significance and suspected collinearity with `CCF`, which describes the same process: competition. Finally, `SLOPE`*^2* can be removed based on significance.

```{r}
#reduce
#CR^2, PCCF, SLOPE^2
an_df_red <- lmer(log(tdds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_weib+
                    #climate
                    #competition/density
                    z.BAL+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                        data = glmm_df_z)
AIC(an_df_red)
summary(an_df_red)$coef
```

Also, it may not be necessary to include two competition factors (CCF and BAL). We can reduce BAL due to its collinearity with CR.

```{r}
#reduce
#BAL
an_df_red <- lmer(log(tdds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_weib+
                    #climate
                    #competition/density
                    z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                        data = glmm_df_z)
AIC(an_df_red)
summary(an_df_red)$coef
```

Model fails to converge without `BAL`. In addition, getting rid of `BAL` increases the AIC value. We could also try substituting `sin` and `cos`, the radiation parameters, for a single solar radiation parameter, such as the Swift's solar radiation potential (1976).

```{r}
#reduce
#sin+cos
an_df_red <- lmer(log(tdds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_weib+
                    #climate
                    #competition/density
                    z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                        data = glmm_df_z)
AIC(an_df_red)
summary(an_df_red)$coef
```

# Annual Model with Climate

A tree's growth response is also influenced by climate, or temperature and precipitation, during the growing season. By annualizing the model with tree rings, climate can be included as a covariate. `ppt_` is the total precipitation over the following monthly range. `tmin/max_` is the average temperature over the following monthly range. Climate variables were chosen based on model AIC score, as well as ability to project into the future (e.g. `wateryr`).

```{r warning=FALSE}
#add climate
#for df, Jun is important
#previous Jun is the most correlated
#with pJun-Aug giving the best AIC
#however a specific seasonal range of precipitation might be hard to predict
#use 16mon pJun-Sep
#better AIC than wateryear
clim_1 <- lmer(log(tdds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+I(z.CR_weib^2)+
                 #climate
                 z.ppt_pJunAug+z.tmax_FebJul+ 
                 #competition/density
                 z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)
AIC(clim_1)
clim_16 <- lmer(log(tdds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+I(z.CR_weib^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)
AIC(clim_16)
```

## Model Selection

### Collinearity

Using the full model with all the possile covariates, I will test for collinearity between predictors with the `car` package.

```{r}
vif(clim_16)
```

There are no parameters above 3, but crown ratio (CR_weib) and basal area of trees larger than the subject tree (BAL) appear to be mildly correlated. Crown competition factor of the subplot (PCCF) and the stand (CCF) also seem to be mildly correlated.

With VIF scores below 3, the model can be reduced based on significance or importance (i.e. coeficient value).

```{r}
summary(clim_16)$coef
```

`CR_weib`*^2* can be removed based on significance. `PCCF` can be removed based on significance and suspected collinearity with `CCF`, which describes the same process: competition. Finally, `SLOPE`*^2* can be removed based on significance.

```{r warning=FALSE}
#reduce based on significance
#CR^2
#PCCF
#Slope^2
clim_16_red <- lmer(log(tdds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_weib+
                 #climate 
                 z.ppt_pJunSep*z.tmax_FebJul+ #interaciton significant
                 #competition/density
                 z.BAL+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_df_z)
AIC(clim_16_red)
summary(clim_16_red)$coef
```

Also, it may not be necessary to include two competition factors (CCF and BAL). We can reduce BAL due to its collinearity with CR.

```{r}
#reduce
#BAL
clim_16_red <- lmer(log(tdds)~
                      #tree variables
                      z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                      z.CR_weib+
                      #climate 
                      z.ppt_pJunSep*z.tmax_FebJul+ #interaciton significant
                      #competition/density
                      z.CCF+ #remove /100 due to standardization
                      #site variables
                      z.SICOND+z.SLOPE+
                      z.sin+z.cos+
                      #random effects
                      (1+z.DIA_C|TRE_CN)+(1|Year),
                    data = glmm_df_z)
AIC(clim_16_red)
summary(clim_16_red)$coef
```

Getting rid of `BAL` increases the AIC value. We could also try substituting `sin` and `cos`, the radiation parameters, for a single solar radiation parameter, such as the Swift's solar radiation potential (1976).

```{r}
#reduce
#sin + cos
clim_16_red <- lmer(log(tdds)~
                      #tree variables
                      z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                      z.CR_weib+
                      #climate 
                      z.ppt_pJunSep*z.tmax_FebJul+ #interaciton significant
                      #competition/density
                      z.CCF+ #remove /100 due to standardization
                      #site variables
                      z.SICOND+z.SLOPE+
                      #random effects
                      (1+z.DIA_C|TRE_CN)+(1|Year),
                    data = glmm_df_z)
AIC(clim_16_red)
summary(clim_16_red)$coef
```


## Model Diagnostics

### Test of Normality

The linear mixed effect model assumes a Gaussian (normal) distribution. To test that assumption, a quantile-quantile (qq) plot will plot our distribution against a normal distribution.


```{r echo=FALSE}
#residuals
par(mfrow=c(2,2))

#full annual
resid_annual<- residuals(annual_df,type="pearson",scaled=TRUE)
qqnorm(resid_annual,main="QQ plot of Full Annual")
qqline(resid_annual)
hist(resid_annual, breaks = 50, main = "Histogram of Full Annual Residuals")

#annual reduced
resid_annred <- residuals(an_df_red,type="pearson",scaled=TRUE)
qqnorm(resid_annred,main="QQ plot of Reduced Annual")
qqline(resid_annred)
hist(resid_annred, breaks = 50, main = "Histogram of Reduced Annual Residuals")

#clim_16
resid_clm<- residuals(clim_16,type="pearson",scaled=TRUE)
qqnorm(resid_clm,main="QQ plot of Full Climate")
qqline(resid_clm)
hist(resid_clm, breaks = 50, main = "Histogram of Full Climate Residuals")

#clim_16_red
resid_clmred <- residuals(clim_16_red,type="pearson",scaled=TRUE)
qqnorm(resid_clmred,main="QQ plot of Reduced Climate")
qqline(resid_clmred)
hist(resid_clmred, breaks = 50, main = "Histogram of Reduced Climate Residuals")
```

### Test of Homoscedasticity

```{r include=FALSE}
library(gplots)
```

To test if my transformed residuals have a constant variance with a mean of zero, I will plot transformed residuals vs predicted values.

```{r}
par(mfrow=c(2,2))
pred_annual <- predict(annual_df, type="response")
plotLowess(resid_annual~pred_annual, ylab="Residuals",xlab="Predicted", main="Full Annual")
pred_annred <- predict(an_df_red, type="response")
plotLowess(resid_annred~pred_annred, ylab="Residuals",xlab="Predicted", main="Reduced Annual")
pred_clm <- predict(clim_16, type="response")
plotLowess(resid_clm~pred_clm, ylab="Residuals",xlab="Predicted", main="Full Climate")
pred_clmred <- predict(clim_16_red, type="response")
plotLowess(resid_clmred~pred_clmred, ylab="Residuals",xlab="Predicted", main="Reduced Climate")
```

We can also test if residuals have a constant variance against predictor variables. Below plots are only given for the reduced climate model, but more models can be plotted.

```{r echo=FALSE}
par(mfrow=c(2,2))
#dbh
plotLowess(resid_clmred~z.DIA_C,data = glmm_df_z,ylab="Residuals",main="Climate Reduced: DBH")
#plotLowess(resid_lmm1~z.DIA_C,data = glmm_df_z,ylab="Residuals",main="LMM1")
#CR
plotLowess(resid_clmred~z.CR_weib,data = glmm_df_z,ylab="Residuals",main="Climate Reduced: CR")
#plotLowess(resid_lmm1~z.CR_weib,data = glmm_df_z,ylab="Residuals",main="LMM1")
#precip
plotLowess(resid_clmred~z.ppt_pJunAug,data = glmm_df_z,ylab="Residuals",main="Climate Reduced: Precip") 
#plotLowess(resid_lmm1~z.ppt_pJunAug,data = glmm_df_z,ylab="Residuals",main="LMM1") 
#temp
plotLowess(resid_clmred~z.tmax_FebJul,data = glmm_df_z,ylab="Residuals",main="Climate Reduced: Temp")
#plotLowess(resid_lmm1~z.tmax_FebJul,data = glmm_df_z,ylab="Residuals",main="LMM1")
#CCF
plotLowess(resid_clmred~z.CCF,data = glmm_df_z,ylab="Residuals",main="Climate Reduced: CCF")
#plotLowess(resid_lmm1~z.CCF,data = glmm_df_z,ylab="Residuals",main="LMM1")
#SI
plotLowess(resid_clmred~z.SICOND,data = glmm_df_z,ylab="Residuals",main="Climate Reduced: SI")
#plotLowess(resid_lmm1~z.SICOND,data = glmm_df_z,ylab="Residuals",main="LMM1")
#Slope
plotLowess(resid_clmred~z.SLOPE,data = glmm_df_z,ylab="Residuals",main="Climate Reduced: Slope")
#plotLowess(resid_lmm1~z.SLOPE,data = glmm_df_z,ylab="Residuals",main="LMM1")
```

### Mining

```{r}
#reduced models
#BALIVE


```


## Visualization

```{r include=FALSE}
library(broom.mixed)
library(dotwhisker)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
full_an_df <-  tidy(annual_df) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Full Annual")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_weib = "Crown Ratio",
                       "I(z.CR_weib^2)" = "CR^2",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2",
                       z.sin = "sin(Aspect-0.7854)*Slope",
                       z.cos = "cos(Aspect-0.7854)*Slope"))
red_an_df <-  tidy(an_df_red) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Reduced Annual")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_weib = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       z.sin = "sin(Aspect-0.7854)*Slope",
                       z.cos = "cos(Aspect-0.7854)*Slope"))
full_clim_df <-  tidy(clim_16) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Full Climate")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_weib = "Crown Ratio",
                       "I(z.CR_weib^2)" = "CR^2",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2",
                       z.sin = "sin(Aspect-0.7854)*Slope",
                       z.cos = "cos(Aspect-0.7854)*Slope"))
red_clim_df <-  tidy(clim_16_red) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Reduced Climate")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_weib = "Crown Ratio",
                       "I(z.CR_weib^2)" = "CR^2",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2",
                       z.sin = "sin(Aspect-0.7854)*Slope",
                       z.cos = "cos(Aspect-0.7854)*Slope"))
models_df <- full_join(full_an_df,red_an_df) %>%
  full_join(.,full_clim_df) %>%
  full_join(.,red_clim_df)
dwplot(models_df, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
       # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  ggtitle("Growth for Douglas Fir") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
```

## Interpretation

We can start to understand the influence of the covariate on the response variable, tree growth, with the `effects` package. Keeping all other variables constant, it shows the effect of the covariate on the reponse.

```{r include=FALSE}
library(effects)
```

### Diameter at Breast Height

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.DIA_C",annual_df),xlab = "DBH",main = "Full Annual")
plot(effect("z.DIA_C",an_df_red),xlab = "DBH",main = "Reduced Annual")
plot(effect("z.DIA_C",clim_16),xlab = "DBH",main = "Full Climate")
plot(effect("z.DIA_C",clim_16_red),xlab = "DBH",main = "Reduced Climate")
```

### Crown Ratio

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.CR_weib",annual_df),xlab = "Crown Ratio",main = "Full Annual")
plot(effect("z.CR_weib",an_df_red),xlab = "Crown Ratio",main = "Reduced Annual")
plot(effect("z.CR_weib",clim_16),xlab = "Crown Ratio",main = "Full Climate")
plot(effect("z.CR_weib",clim_16_red),xlab = "Crown Ratio",main = "Reduced Climate")
```

### Crown Competition Factor

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.CCF",annual_df),xlab = "CCF",main = "Full Annual")
plot(effect("z.CCF",an_df_red),xlab = "CCF",main = "Reduced Annual")
plot(effect("z.CCF",clim_16),xlab = "CCF",main = "Full Climate")
plot(effect("z.CCF",clim_16_red),xlab = "CCF",main = "Reduced Climate")
```

### Site Index

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.SICOND",annual_df),xlab = "Site Index",main = "Full Annual")
plot(effect("z.SICOND",an_df_red),xlab = "Site Index",main = "Reduced Annual")
plot(effect("z.SICOND",clim_16),xlab = "Site Index",main = "Full Climate")
plot(effect("z.SICOND",clim_16_red),xlab = "Site Index",main = "Reduced Climate")
```

### Slope

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.SLOPE",annual_df),xlab = "Slope",main = "Full Annual")
plot(effect("z.SLOPE",an_df_red),xlab = "Slope",main = "Reduced Annual")
plot(effect("z.SLOPE",clim_16),xlab = "Slope",main = "Full Climate")
plot(effect("z.SLOPE",clim_16_red),xlab = "Slope",main = "Reduced Climate")
```

### Radiation

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.sin",annual_df),xlab = "sin(Aspect-0.7854)*Slope",main = "Full Annual")
plot(effect("z.sin",an_df_red),xlab = "sin(Aspect-0.7854)*Slope",main = "Reduced Annual")
plot(effect("z.sin",clim_16),xlab = "sin(Aspect-0.7854)*Slope",main = "Full Climate")
plot(effect("z.sin",clim_16_red),xlab = "sin(Aspect-0.7854)*Slope",main = "Reduced Climate")
```

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.cos",annual_df),xlab = "cos(Aspect-0.7854)*Slope",main = "Full Annual")
plot(effect("z.cos",an_df_red),xlab = "cos(Aspect-0.7854)*Slope",main = "Reduced Annual")
plot(effect("z.cos",clim_16),xlab = "cos(Aspect-0.7854)*Slope",main = "Full Climate")
plot(effect("z.cos",clim_16_red),xlab = "cos(Aspect-0.7854)*Slope",main = "Reduced Climate")
```

### Climate

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(1,2))
plot(effect("z.ppt_pJunSep",clim_16),xlab = "Precipitation",main = "Full Climate")
plot(effect("z.ppt_pJunSep",clim_16_red),xlab = "Precipitation",main = "Reduced Climate")
plot(effect("z.tmax_FebJul",clim_16),xlab = "Temperature",main = "Full Climate")
plot(effect("z.tmax_FebJul",clim_16_red),xlab = "Temperature",main = "Reduced Climate")
```
```{r echo=FALSE}
plot(effect("z.ppt_pJunSep:z.tmax_FebJul",clim_16),xlab = "Interaction",main = "Full Climate")
plot(effect("z.ppt_pJunSep:z.tmax_FebJul",clim_16_red),xlab = "Interaction",main = "Reduced Climate")
```

