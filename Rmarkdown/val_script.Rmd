---
title: "Validation"
author: "Courtney Giebink"
date: "May 14, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
```


## Models

For each species, fit 2 growth models: 1) annualized with tree rings and 2) annualized with tree rings and includes the effect of climate.

### Douglas fir

```{r}
#load data
#load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_df_z.Rdata")
#tree ring model
an_al_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_df_z)
an_red_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_df_z)
#try without radiation
an_red2_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_df_z)
#tr+climate model
clim_al_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+I(z.CR_fvs^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.BAL+z.PCCF+#z.CCF+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
clim_red_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ 
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
#try without radiation
clim_red2_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ 
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
#Constand CR
an_mod_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    # (1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                   (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_df_z)
clim_mod_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
```

```{r}
library(r2glmm)
r2beta(an_al_df)
r2beta(an_red_df)
r2beta(clim_al_df)
r2beta(clim_red_df)
r2beta(clim_mod_df)
```

```{r}
#plot r2
r2_aclim_df <- as.data.frame(r2beta(clim_al_df))
r2_aclim_df$model <- "All Climate"
r2_rclim_df <- as.data.frame(r2beta(clim_red_df))
r2_rclim_df$model <- "Reduced Climate"
r2_df <- bind_rows(r2_aclim_df,r2_rclim_df)
```

```{r}
#write.csv(r2_df,file = "./data/formatted/r2_df.csv")
#edit effect names and reload
#r2_df <- read_csv("./data/formatted/r2_df.csv")
```

```{r}
ggplot(data = r2_df,aes(color = model)) + 
  geom_pointrange(data = r2_df,aes(x = Effect, y = Rsq,ymin = lower.CL, ymax = upper.CL))
ggplot(data = r2_df,aes(x = Effect, y = Rsq,color = model)) + 
  geom_point()
```

### Ponderosa pine

```{r}
#load data
#load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_pp_z.Rdata")
#tree ring model
an_al_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_pp_z)
AIC(an_all_pp)
an_red_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_pp_z)
AIC(an_red_pp)
#try also
an_red2_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_pp_z)
AIC(an_red2_pp)
#tr + climate model
clim_al_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.CR_fvs+I(z.CR_fvs^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
AIC(clim_al_pp)
clim_red_pp <- lmer(log(dds)~
                       #tree variables
                       z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                       #climate
                       z.ppt_pJunSep+z.tmax_JunAug+
                       #competition/density
                       z.BAL+ #remove /100 due to standardization
                       #site variables
                       z.SICOND+
                       #z.solrad_MayAug+
                       #random effects
                       (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                     data = glmm_pp_z)
AIC(clim_red_pp)
#also try
#slope and solrad have about same AIC
clim_red2_pp <- lmer(log(dds)~
                       #tree variables
                       z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                       #climate
                       z.ppt_pJunSep+z.tmax_JunAug+
                       #competition/density
                       z.BAL+ #remove /100 due to standardization
                       #site variables
                       z.SICOND+
                       z.solrad_MayAug+
                       #random effects
                       (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                     data = glmm_pp_z)
AIC(clim_red2_pp)
#constant CR
#bal, ccf, and sdi all have about same AIC
an_mod_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     #competition/density
                     z.SDI+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
AIC(an_mod_pp)
clim_mod_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep+z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.SDI+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
AIC(clim_mod_pp)
```

```{r}
r2beta(an_al_pp)
r2beta(an_red_pp)
r2beta(clim_al_pp)
r2beta(clim_red_pp)
```

```{r}
#plot r2
r2_aclim_pp <- as.data.frame(r2beta(clim_al_pp))
r2_aclim_pp$model <- "Full Climate"
r2_rclim_pp <- as.data.frame(r2beta(clim_red_pp))
r2_rclim_pp$model <- "Reduced Climate"
r2_pp <- bind_rows(r2_aclim_pp,r2_rclim_pp)
```

```{r}
#write.csv(r2_pp,file = "./data/formatted/r2_pp.csv")
#edit effect names and reload
#r2_pp <- read_csv("./data/formatted/r2_pp.csv")
```

```{r}
ggplot(data = r2_pp,aes(color = model)) + 
  geom_pointrange(data = r2_pp,aes(x = Effect, y = Rsq,ymin = lower.CL, ymax = upper.CL))
ggplot(data = r2_pp,aes(x = Effect, y = Rsq, color = model)) + 
  geom_point()
```

### Engelmann spruce

```{r}
#load data
#load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_es_z.Rdata")
#tree ring model
an_al_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.CCF+#z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+#I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_al_es)
an_red_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+ #reduces AIC by 4
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red_es)
#tr + climate model
clim_al_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_fvs+I(z.CR_fvs^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+z.CCF+#z.PCCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+#I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_es_z)
AIC(clim_al_es)
clim_red_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+ 
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_red_es)
#constant CR
an_mod_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.BAL+#remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_mod_es)
clim_mod_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_mod_es)
```

```{r}
r2beta(an_al_es)
r2beta(an_red_es)
r2beta(clim_al_es)
r2beta(clim_red_es)
r2beta(clim_mod_es)
```

```{r}
#plot r2
r2_aclim_es <- as.data.frame(r2beta(clim_al_es))
r2_aclim_es$model <- "Full Climate"
r2_rclim_es <- as.data.frame(r2beta(clim_red_es))
r2_rclim_es$model <- "Reduced Climate"
r2_cr_es <- as.data.frame(r2beta(clim_mod_es))
r2_cr_es$model <- "Modified CR"
r2_es <- bind_rows(r2_weib_es,r2_cr_es)
```

```{r}
#write.csv(r2_es,file = "./data/formatted/r2_es.csv")
#edit effect names and reload
#r2_es <- read_csv("./data/formatted/r2_es.csv")
```

```{r}
ggplot(data = r2_es,aes(color = model)) + 
  geom_pointrange(data = r2_es,aes(x = Effect, y = Rsq,ymin = lower.CL, ymax = upper.CL))
ggplot(data = r2_es,aes(x = Effect, y = Rsq, color = model)) + 
  geom_point()
```


## Validation

Validate models by using them to predict growth and compare to observed values. The validation data set is independent from the calibration data set. The calibration data set has trees measured in the 1990s. The validation data set has different trees measured twice between the years of 2000-2017. For example, one tree could be measured in 2000 and again in 2010. I will take the measurement from 2000, predict growth every year until 2010, and compare the prediction with the observed value for 2010.

### Inputs

```{r}
#data frames to standardize covariates in the model
df_stats <- glmm_df_z %>%
  ungroup() %>%
  dplyr::select(DIA_C,SICOND,tASPECT,SLOPE,BAL,SDI,CR_fvs,CR,CR_fvs,PCCF,CCF,
         cos,sin,solrad_MayAug,ppt_pJunSep,tmax_FebJul) %>%
  sapply(.,function(x) c(mean=mean(x,na.rm = T),
                         sd=sd(x,na.rm = T)))
pp_stats <- glmm_pp_z %>%
  ungroup() %>%
  dplyr::select(DIA_C,SICOND,tASPECT,SLOPE,BAL,SDI,CR_fvs,CR,CR_fvs,PCCF,CCF,
         cos,sin,solrad_MayAug,ppt_pJunSep,tmax_JunAug) %>%
  sapply(.,function(x) c(mean=mean(x,na.rm = T),
                         sd=sd(x,na.rm = T)))
es_stats <- glmm_es_z %>%
  ungroup() %>%
  dplyr::select(DIA_C,SICOND,tASPECT,SLOPE,BAL,SDI,CR_fvs,CR,CR_fvs,PCCF,CCF,
         cos,sin,solrad_MayAug,ppt_pJunSep,tmax_pAug) %>%
  sapply(.,function(x) c(mean=mean(x,na.rm = T),
                         sd=sd(x,na.rm = T)))
sp_stats <- list(sp_202 = df_stats, sp_122 = pp_stats,sp_93 = es_stats)
```

```{r}
#data frame for density/competition equations
bratio_df <- data.frame(species=c(93,202,122),
                        #93=ES,202=DF,122=PP
                        b1 = c(0.9502,0.867,0.8967),
                        b2 = c(-0.2528, 0, -0.4448),
                        exp = c(1,0,1))
ccf_df <- data.frame(species=c(93,202,122),
                     #93=ES,202=DF,122=PP,
                     r1 = c(0.03,0.11,0.03),
                     r2 = c(0.0173,0.0333,0.0180),
                     r3 = c(0.00259,0.00259,0.00281),
                     r4 = c(0.007875,0.017299,0.007813),
                     r5 = c(1.7360,1.5571,1.7680),
                     dbrk = c(1,1,1))
CR_fvs_df <- data.frame(species=c(93,202,122),
                         #93=ES,202=DF,122=PP
                         SDIMAX = c(620,570,446),
                         a0 = c(1,1,1),
                         b0 = c(-0.90648,-0.24217,-0.82631),
                         b1 = c(1.08122,0.96529,1.06217),
                         c0 = c(3.48889,-7.94832,-1.02873),
                         c1 = c(0,1.93832,0.80143),
                         d0 = c(6.81087,7.46296,6.19911),
                         d1 = c(-0.01037,-0.02944,-0.02216))
```

### Function

The function must take the validation trees and predict growth for the next year. Then use that prediction to calculate density/competition covariates for that year on the plot level. Then use the covariates to predict growth for the next year. Repeat until it has reached the remeasurement year (`fMEASYEAR`).


```{r}
val_an <- function(newdata,cr_int,mod_df,mod_pp,mod_es,sp_stats,nonfocal,bratio,ccf_df,CR_fvs_df) {
  #parameters:
  #newdata - validataion trees from FIADB
  newdata_rep <- newdata %>%
    ungroup() %>%
    dplyr::select(PLT_CN, TRE_CN, SPCD, SUBP, MEASYEAR, 
                  TPA_UNADJ, DESIGNCD, tCONDID, census_int,
                  ASPECT,SLOPE,sin,cos,LAT,LON,ELEV,
                  FVS_LOC_CD,SDImax,SICOND_c,solrad_MayAug, fMEASYEAR, fDIA) %>%
    mutate(Year = NA,
           DIA = NA,
           CCF = NA,
           PCCF = NA,
           BAL = NA,
           SDI = NA,
           CR_fvs = NA)
  newdata_rep <- newdata_rep %>% 
    group_by(TRE_CN) %>%
    slice(rep(1:n(), each = census_int+1)) %>%
    mutate(Year = (MEASYEAR[1]:fMEASYEAR[1])) %>% #repeated data frame ready  to fill in
    ungroup()
  ##density for new data in MEASYEAR will already be calculated
  #fill in DIA,CCF, PCCF, BAL, SDI, CR_fvs, where year = measyear
  for(i in 1:nrow(newdata_rep)){
    TRE_CN <- newdata_rep$TRE_CN[i]
    if(newdata_rep$Year[i] == newdata_rep$MEASYEAR[i]){
      newdata_rep$DIA[i] <- newdata$DIA[newdata$TRE_CN == TRE_CN]
      newdata_rep$CCF[i] <- newdata$CCF[newdata$TRE_CN == TRE_CN]
      newdata_rep$PCCF[i] <- newdata$PCCF[newdata$TRE_CN == TRE_CN]
      newdata_rep$BAL[i] <- newdata$BAL[newdata$TRE_CN == TRE_CN]
      newdata_rep$SDI[i] <- newdata$SDI[newdata$TRE_CN == TRE_CN]
      newdata_rep$CR_fvs[i] <- newdata$CR[newdata$TRE_CN == TRE_CN]
    }
  }
  #mod_obj - list of model objects for each species
  #sp_stats - list of species statistics (mean and standard deviation) for each covariate
  ##will be used to standardize newdata covariates
  #nonfocal - trees on the same plot as validation trees
  nonfocal <- nonfocal %>%
    ungroup()
  ##will be used to compute density parameters
  #bratio - dataframe of bark ratio constants for equation
  #ccf - dataframe of crown competiton factor constants for equation
  #CR_fvs_df - dataframe of crown ratio constants for equation
  
  #empty dataframe to add results
  pred_df <- newdata_rep[FALSE,]
  
  # loop over plot
  # to calculate density after MEASYR
  for(i in unique(newdata_rep$PLT_CN)) {
    #create plot dataframe to predict growth
    plt_df <- newdata_rep[newdata_rep$PLT_CN == i,]
    #assign projection start year
    growthyr <- plt_df$MEASYEAR[1] # assumes all trees on a plot have same MEASYEAR
    while (growthyr <= (plt_df$fMEASYEAR[1]-1)){ #stops the year before fMEASYEAR
      #filter dataframe for year of projection
      plt_yr_df <- plt_df %>%
        filter(Year == growthyr)
      
      for(i in 1:nrow(plt_yr_df)) {#for each tree on plot in given year
        Species <- plt_yr_df$SPCD[i]
        TRE_CN <- plt_yr_df$TRE_CN[i]
        
        #select model to predict growth
        #models are species specific
        if(Species == 202){mod_obj <- mod_df} 
        if(Species == 122){mod_obj <- mod_pp} 
        if(Species == 93){mod_obj <- mod_es} 
        
        #standardize covariates
        #get mean/sd for each species
        if(Species == 202){para_std <- sp_stats$sp_202}
        if(Species == 122){para_std <- sp_stats$sp_122}
        if(Species == 93) {para_std <- sp_stats$sp_93}

        #first row is mean, second row is sd
        #the inputs of the equation are from a list so output needs to be unlisted
        plt_yr_df$z.DIA_C[i] = unlist((plt_yr_df[i,"DIA"] - para_std[1,"DIA_C"]) / para_std[2,"DIA_C"])
        plt_yr_df$z.CR_fvs[i] = unlist((plt_yr_df[i,"CR_fvs"] - para_std[1,"CR_fvs"]) / para_std[2,"CR_fvs"])
        plt_yr_df$z.BAL[i] = unlist((plt_yr_df[i,"BAL"] - para_std[1,"BAL"]) / para_std[2,"BAL"])
        plt_yr_df$z.CCF[i] = unlist((plt_yr_df[i,"CCF"] - para_std[1,"CCF"]) / para_std[2,"CCF"])
        plt_yr_df$z.PCCF[i] = unlist((plt_yr_df[i,"PCCF"] - para_std[1,"PCCF"]) / para_std[2,"PCCF"])
        plt_yr_df$z.SDI[i] = unlist((plt_yr_df[i,"SDI"] - para_std[1,"SDI"]) / para_std[2,"SDI"])
        plt_yr_df$z.SICOND[i] = unlist((plt_yr_df[i,"SICOND_c"] - para_std[1,"SICOND"]) / para_std[2,"SICOND"])
        plt_yr_df$z.SLOPE[i] = unlist((plt_yr_df[i,"SLOPE"] - para_std[1,"SLOPE"]) / para_std[2,"SLOPE"])
        plt_yr_df$z.sin[i] = unlist((plt_yr_df[i,"sin"] - para_std[1,"sin"]) / para_std[2,"sin"])
        plt_yr_df$z.cos[i] = unlist((plt_yr_df[i,"cos"] - para_std[1,"cos"]) / para_std[2,"cos"])
        plt_yr_df$z.solrad_MayAug[i] = unlist((plt_yr_df[i,"solrad_MayAug"] - para_std[1,"solrad_MayAug"]) / para_std[2,"solrad_MayAug"])
        #TODO there must be a better way to do this? for loop?

        #predict
        # modobj will change with different species
        plt_yr_df$log_dds[i] <- predict(object = mod_obj, newdata = plt_yr_df[i,], 
                                        re.form = NA, type = "response")
        #re.form specify random effects to include
        ##NA include none
        
        #see page 53 of prognosis model
        #DG = sqrt((DBH/k)^2 + dds) - (DBH/k)
        # k = 1/BRATIO
        #see UT variant guide
        #BRATIO = b1+b2/(DBH^exp)
        b1 <- bratio$b1[bratio$species == Species]
        b2 <- bratio$b2[bratio$species == Species]
        exp <- bratio$exp[bratio$species == Species]
        BRATIO <- b1 + b2/(plt_yr_df$DIA[i]^exp) 
        #exp determines if use equation 4.2.1/3 or 4.2.2 in UT variant guide
        k <- 1/BRATIO 
        #DG = sqrt((DBH/k)^2 + dds - (DBH/k))
        plt_yr_df$DG[i] <- k * (sqrt((plt_yr_df$DIA[i]/k)^2 + exp(plt_yr_df$log_dds[i])) -
                                  (plt_yr_df$DIA[i]/k))
      }
      
      #so DBH0 + k*DG = DBH
      plt_yr2_df <- plt_df %>%
        filter(Year == (growthyr+1))%>%
        mutate(DIA = plt_yr_df$DIA + plt_yr_df$DG)
      
      #join with nonfocal
      #fitler for trees on plots in validation set in same year
      non_foc_filt <- nonfocal %>%
        dplyr::select(PLT_CN, TRE_CN, SUBP, SPCD,TPA_UNADJ,Year,DIA_int) %>%
        mutate(DIA = DIA_int) %>%
        filter(PLT_CN == plt_yr2_df$PLT_CN[1],
               Year == plt_yr2_df$Year[1])
      #join
      density_cal <- bind_rows(plt_yr2_df,non_foc_filt)
      
      #compute density parameters
      #ccf
      for(i in 1:nrow(density_cal)){
        Species <- density_cal$SPCD[i]
        r1 <- ccf_df$r1[ccf_df$species == Species]
        r2 <- ccf_df$r2[ccf_df$species == Species]
        r3 <- ccf_df$r3[ccf_df$species == Species]
        r4 <- ccf_df$r4[ccf_df$species == Species]
        r5 <- ccf_df$r5[ccf_df$species == Species]
        dbrk <- ccf_df$dbrk[ccf_df$species == Species]
        if(Species == 475){
          ifelse(density_cal$DIA[i] < dbrk,
                 CCF_t <- density_cal$DIA[i]*(r1+r2+r3),
                 CCF_t <- r1 + (r2 * density_cal$DIA[i]) + (r3 * density_cal$DIA[i]^2))
        }
        if(Species != 475){
          ifelse(is.na(density_cal$DIA[i]), 
                 CCF_t <- NA,
                 ifelse(density_cal$DIA[i] <= 0.1, 
                        CCF_t <- 0.0001,
                        ifelse(density_cal$DIA[i] < dbrk, 
                               CCF_t <- r4 * (density_cal$DIA[i]^r5),
                               CCF_t <- r1 + (r2 * density_cal$DIA[i]) + (r3 * density_cal$DIA[i]^2))))
        }
        density_cal$CCF_t[i] <- CCF_t
      }
      
      density_cal <- density_cal %>%
        group_by(PLT_CN,SUBP,Year) %>%
        mutate(PCCF = sum(CCF_t * (TPA_UNADJ * 4), na.rm = TRUE))
      
      #stand CCF = sum(CCFt on a plot) on a per acre basis
      #TPA measured on a plot/stand level
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(CCF = sum(CCF_t * TPA_UNADJ,na.rm = TRUE))
      
      #bal
      density_cal <- density_cal %>%
        mutate(BA_pa = ((DIA^2) * 0.005454) * TPA_UNADJ)
      
      #rank trees per year per plot
      #sum BApa of trees larger on the same plot in same year
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(rank_pltyr = rank(DIA, na.last = TRUE, ties.method = "min")) %>%
        #min assigns lowest value to ties (1,2,3,3,5,6)
        mutate(BAL = map_dbl(DIA,~sum(BA_pa[DIA>.x],na.rm = TRUE)))
      
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(SDI = sum(TPA_UNADJ*(DIA/10)^1.6), #stage
               num_t = length(unique(TRE_CN)))
      
      #filter for focal trees
      plt_yr2_df <- density_cal %>%
        filter(TRE_CN %in% plt_yr_df$TRE_CN)
      
      #cr
      for(i in 1:nrow(plt_yr2_df)){
        #Function arguments:
        #SPCD - is number code of species of tree record
        #SDI - is SDI of stand (Stage 1968)
        Species <- plt_yr2_df$SPCD[i]
        #SDI max values for each species were pulled from UT Variant overview
        SDIMAX <- ifelse(is.na(plt_yr2_df$SDImax[i]),
                         CR_fvs_df$SDIMAX[CR_fvs_df$species == Species],
                         plt_yr2_df$SDImax[i])
        #Calculate relative density
        RD <- plt_yr2_df$SDI[i]/SDIMAX
        
        #Calculate average stand crown ratio (ACR) for each species in the stand
        d0 <- CR_fvs_df$d0[CR_fvs_df$species == Species]
        d1 <- CR_fvs_df$d1[CR_fvs_df$species == Species]
        ACR <- d0 + d1 * RD * 100
        
        #Parameters of Weibull distribution: A,B,C
        a0 <- CR_fvs_df$a0[CR_fvs_df$species == Species]
        b0 <- CR_fvs_df$b0[CR_fvs_df$species == Species]
        b1 <- CR_fvs_df$b1[CR_fvs_df$species == Species]
        c0 <- CR_fvs_df$c0[CR_fvs_df$species == Species]
        c1 <- CR_fvs_df$c1[CR_fvs_df$species == Species]
        
        #A parameter
        WEIBA <-a0
        #B parameter
        WEIBB <- b0 + b1*ACR
        #C parameter
        WEIBC <- c0 + c1*ACR
        
        #Function arguments:
        
        #CCF - crown competition factor of stand
        #rank_pltyr - tree's rank in diameter distribution by plot by year
        #N  - number of records in the stand by year
        
        #Calculate scale parameter
        SCALE = (1.0 - .00167 * (plt_yr2_df$CCF[i]-100.0))
        if(SCALE < 0.3){SCALE = 0.3}
        if(SCALE > 1.0){SCALE = 1.0}
        
        N <- plt_yr2_df$num_t[i]
        #X is tree's rank in diameter distribution
        #Multiply tree's rank in diameter distribution (trees position relative to tree with largest diameter in the stand) by scale parameter
        Y <- plt_yr2_df$rank_pltyr[i]/N * SCALE
        if(Y < 0.05){Y = 0.05}
        if(Y > 0.95){Y = 0.95}
        #Constrain Y between 0.05 and 0.95 - crown ratio predictions in FVS are bound between these two values
        
        #Calculate crown ratio (this corresponds to variable X in UTAH variant overview)
        X <- WEIBA + WEIBB*((-1*log(1-Y))^(1/WEIBC))
        #X = a tree’s crown ratio expressed as a percent / 10
        CR_fvs <- X * 10
        
        #get CR the year before
        TRE_CN <- plt_yr2_df$TRE_CN[i]
        #growthyr is still previous year
        CR_1 <- plt_df$CR_fvs[plt_df$TRE_CN == TRE_CN & 
                                plt_df$Year == growthyr] #or CR_fvs[N] for the first round
        #bound to 1% change per year
        cr_bound1 <- CR_1 * .01
        plt_yr2_df$CR_fvs[i] <- ifelse(CR_1 > CR_fvs, 
                                          CR_1 - cr_bound1,
                                          CR_1 + cr_bound1)
      }

      #join with plt_df
      for(i in 1:nrow(plt_df)){
        TRE_CN <- plt_df$TRE_CN[i]
        if(plt_df$Year[i] == (growthyr + 1)){
          plt_df$DIA[i] <- plt_yr2_df$DIA[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$CCF[i] <- plt_yr2_df$CCF[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$PCCF[i] <- plt_yr2_df$PCCF[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$BAL[i] <- plt_yr2_df$BAL[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$SDI[i] <- plt_yr2_df$SDI[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$CR_fvs[i] <- plt_yr2_df$CR_fvs[plt_yr2_df$TRE_CN == TRE_CN]
        }
      }
      #add density metrics in
      
      
      #loop over next year
      growthyr = growthyr + 1
    }
    #join plt_df with empty data frame
    #output
    pred_df <- bind_rows(pred_df,plt_df)
    
    #loop over next plot
  }

  return(pred_df)
}
```

```{r}
val_clim <- function(newdata,mod_df,mod_pp,mod_es,sp_stats,nonfocal,bratio,ccf_df,CR_fvs_df,climate) {
  #parameters:
  #newdata - validataion trees from FIADB
  newdata_rep <- newdata %>%
    ungroup() %>%
    dplyr::select(PLT_CN, TRE_CN, SPCD, SUBP, MEASYEAR, 
                  TPA_UNADJ, DESIGNCD, tCONDID, census_int,
                  ASPECT,SLOPE,sin,cos,LAT,LON,ELEV,
                  FVS_LOC_CD,SDImax,SICOND_c,solrad_MayAug, fMEASYEAR, fDIA) %>%
    mutate(Year = NA,
           DIA = NA,
           CCF = NA,
           PCCF = NA,
           BAL = NA,
           SDI = NA,
           CR_fvs = NA)
  newdata_rep <- newdata_rep %>% 
    group_by(TRE_CN) %>%
    slice(rep(1:n(), each = census_int+1)) %>%
    mutate(Year = (MEASYEAR[1]:fMEASYEAR[1])) %>% #repeated data frame ready  to fill in
    ungroup()
  ##density for new data in MEASYEAR will already be calculated
  #fill in DIA,CCF, PCCF, BAL, SDI, CR_fvs, where year = measyear
  #fill climate
  climate <- climate %>%
    ungroup()
  for(i in 1:nrow(newdata_rep)){
    TRE_CN <- newdata_rep$TRE_CN[i]
    if(newdata_rep$Year[i] == newdata_rep$MEASYEAR[i]){
      newdata_rep$DIA[i] <- newdata$DIA[newdata$TRE_CN == TRE_CN]
      newdata_rep$CCF[i] <- newdata$CCF[newdata$TRE_CN == TRE_CN]
      newdata_rep$PCCF[i] <- newdata$PCCF[newdata$TRE_CN == TRE_CN]
      newdata_rep$BAL[i] <- newdata$BAL[newdata$TRE_CN == TRE_CN]
      newdata_rep$SDI[i] <- newdata$SDI[newdata$TRE_CN == TRE_CN]
      newdata_rep$CR_fvs[i] <- newdata$CR[newdata$TRE_CN == TRE_CN]
    }
    #add climate
    #match over tree and year
    newdata_rep$ppt_pJunSep[i] <- climate$ppt_pJunSep[climate$TRE_CN == TRE_CN &
                                                        climate$Year == newdata_rep$Year[i]]
    newdata_rep$tmax_JunAug[i] <- climate$tmax_JunAug[climate$TRE_CN == TRE_CN &
                                                        climate$Year == newdata_rep$Year[i]]
    newdata_rep$tmax_FebJul[i] <- climate$tmax_FebJul[climate$TRE_CN == TRE_CN &
                                                        climate$Year == newdata_rep$Year[i]]
    newdata_rep$tmax_pAug[i] <- climate$tmax_pAug[climate$TRE_CN == TRE_CN &
                                                    climate$Year == newdata_rep$Year[i]]
  }
  
  #mod_obj - list of model objects for each species
  #sp_stats - list of species statistics (mean and standard deviation) for each covariate
  ##will be used to standardize newdata covariates
  #nonfocal - trees on the same plot as validation trees
  nonfocal <- nonfocal %>%
    ungroup()
  ##will be used to compute density parameters
  #bratio - dataframe of bark ratio constants for equation
  #ccf - dataframe of crown competiton factor constants for equation
  #CR_fvs_df - dataframe of crown ratio constants for equation
  #climate - dataframe of climate variables (ppt & tmax) for each tree
  
  #empty dataframe to add results
  pred_df <- newdata_rep[FALSE,]
  
  # loop over plot
  # to calculate density after MEASYR
  for(i in unique(newdata_rep$PLT_CN)) {
    #create plot dataframe to predict growth
    plt_df <- newdata_rep[newdata_rep$PLT_CN == i,]
    #assign projection start year
    growthyr <- plt_df$MEASYEAR[1] # assumes all trees on a plot have same MEASYEAR
    while (growthyr <= (plt_df$fMEASYEAR[1]-1)){ #stops the year before fMEASYEAR
      #filter dataframe for year of projection
      plt_yr_df <- plt_df %>%
        filter(Year == growthyr)
      
      for(i in 1:nrow(plt_yr_df)) {#for each tree on plot in given year
        Species <- plt_yr_df$SPCD[i]
        TRE_CN <- plt_yr_df$TRE_CN[i]
        
        #select model to predict growth
        #models are species specific
        if(Species == 202){mod_obj <- mod_df} 
        if(Species == 122){mod_obj <- mod_pp} 
        if(Species == 93){mod_obj <- mod_es} 
        
        #standardize covariates
        #get mean/sd for each species
        if(Species == 202){para_std <- sp_stats$sp_202}
        if(Species == 122){para_std <- sp_stats$sp_122}
        if(Species == 93) {para_std <- sp_stats$sp_93}
        
        #first row is mean, second row is sd
        #the inputs of the equation are from a list so output needs to be unlisted
        plt_yr_df$z.DIA_C[i] = unlist((plt_yr_df[i,"DIA"] - para_std[1,"DIA_C"]) / para_std[2,"DIA_C"])
        plt_yr_df$z.CR_fvs[i] = unlist((plt_yr_df[i,"CR_fvs"] - para_std[1,"CR_fvs"]) / para_std[2,"CR_fvs"])
        plt_yr_df$z.BAL[i] = unlist((plt_yr_df[i,"BAL"] - para_std[1,"BAL"]) / para_std[2,"BAL"])
        plt_yr_df$z.CCF[i] = unlist((plt_yr_df[i,"CCF"] - para_std[1,"CCF"]) / para_std[2,"CCF"])
        plt_yr_df$z.PCCF[i] = unlist((plt_yr_df[i,"PCCF"] - para_std[1,"PCCF"]) / para_std[2,"PCCF"])
        plt_yr_df$z.SDI[i] = unlist((plt_yr_df[i,"SDI"] - para_std[1,"SDI"]) / para_std[2,"SDI"])
        plt_yr_df$z.SICOND[i] = unlist((plt_yr_df[i,"SICOND_c"] - para_std[1,"SICOND"]) / para_std[2,"SICOND"])
        plt_yr_df$z.SLOPE[i] = unlist((plt_yr_df[i,"SLOPE"] - para_std[1,"SLOPE"]) / para_std[2,"SLOPE"])
        plt_yr_df$z.sin[i] = unlist((plt_yr_df[i,"sin"] - para_std[1,"sin"]) / para_std[2,"sin"])
        plt_yr_df$z.cos[i] = unlist((plt_yr_df[i,"cos"] - para_std[1,"cos"]) / para_std[2,"cos"])
        plt_yr_df$z.solrad_MayAug[i] = unlist((plt_yr_df[i,"solrad_MayAug"] - para_std[1,"solrad_MayAug"]) / para_std[2,"solrad_MayAug"])
        plt_yr_df$z.ppt_pJunSep[i] = unlist((plt_yr_df[i,"ppt_pJunSep"] - 
                                               para_std[1,"ppt_pJunSep"]) / para_std[2,"ppt_pJunSep"])
        #temperature different for each species
        sp_202 <- sp_stats$sp_202
        sp_122 <- sp_stats$sp_122
        sp_93 <- sp_stats$sp_93
        plt_yr_df$z.tmax_FebJul[i] = unlist((plt_yr_df[i,"tmax_FebJul"] -
                                               sp_202[1,"tmax_FebJul"]) /
                                              sp_202[2,"tmax_FebJul"])
        plt_yr_df$z.tmax_JunAug[i] = unlist((plt_yr_df[i,"tmax_JunAug"] -
                                               sp_122[1,"tmax_JunAug"]) /
                                              sp_122[2,"tmax_JunAug"])
        plt_yr_df$z.tmax_pAug[i] = unlist((plt_yr_df[i,"tmax_pAug"] -
                                             sp_93[1,"tmax_pAug"]) / 
                                            sp_93[2,"tmax_pAug"])
        #TODO there must be a better way to do this? for loop?
        
        #predict
        # modobj will change with different species
        plt_yr_df$log_dds[i] <- predict(object = mod_obj, newdata = plt_yr_df[i,], 
                                        re.form = NA, type = "response")
        #re.form specify random effects to include
        ##NA include none
        
        #see page 53 of prognosis model
        #DG = sqrt((DBH/k)^2 + dds) - (DBH/k)
        # k = 1/BRATIO
        #see UT variant guide
        #BRATIO = b1+b2/(DBH^exp)
        b1 <- bratio$b1[bratio$species == Species]
        b2 <- bratio$b2[bratio$species == Species]
        exp <- bratio$exp[bratio$species == Species]
        BRATIO <- b1 + b2/(plt_yr_df$DIA[i]^exp) 
        #exp determines if use equation 4.2.1/3 or 4.2.2 in UT variant guide
        k <- 1/BRATIO 
        #DG = sqrt((DBH/k)^2 + dds - (DBH/k))
        plt_yr_df$DG[i] <- k * (sqrt((plt_yr_df$DIA[i]/k)^2 + exp(plt_yr_df$log_dds[i])) -
                                  (plt_yr_df$DIA[i]/k))
      }
      
      #so DBH0 + k*DG = DBH
      plt_yr2_df <- plt_df %>%
        filter(Year == (growthyr+1))%>%
        mutate(DIA = plt_yr_df$DIA + plt_yr_df$DG)
      
      #join with nonfocal
      #fitler for trees on plots in validation set in same year
      non_foc_filt <- nonfocal %>%
        dplyr::select(PLT_CN, TRE_CN, SUBP, SPCD,TPA_UNADJ,Year,DIA_int) %>%
        mutate(DIA = DIA_int) %>%
        filter(PLT_CN == plt_yr2_df$PLT_CN[1],
               Year == plt_yr2_df$Year[1])
      #join
      density_cal <- bind_rows(plt_yr2_df,non_foc_filt)
      
      #compute density parameters
      #ccf
      for(i in 1:nrow(density_cal)){
        Species <- density_cal$SPCD[i]
        r1 <- ccf_df$r1[ccf_df$species == Species]
        r2 <- ccf_df$r2[ccf_df$species == Species]
        r3 <- ccf_df$r3[ccf_df$species == Species]
        r4 <- ccf_df$r4[ccf_df$species == Species]
        r5 <- ccf_df$r5[ccf_df$species == Species]
        dbrk <- ccf_df$dbrk[ccf_df$species == Species]
        if(Species == 475){
          ifelse(density_cal$DIA[i] < dbrk,
                 CCF_t <- density_cal$DIA[i]*(r1+r2+r3),
                 CCF_t <- r1 + (r2 * density_cal$DIA[i]) + (r3 * density_cal$DIA[i]^2))
        }
        if(Species != 475){
          ifelse(is.na(density_cal$DIA[i]), 
                 CCF_t <- NA,
                 ifelse(density_cal$DIA[i] <= 0.1, 
                        CCF_t <- 0.0001,
                        ifelse(density_cal$DIA[i] < dbrk, 
                               CCF_t <- r4 * (density_cal$DIA[i]^r5),
                               CCF_t <- r1 + (r2 * density_cal$DIA[i]) + (r3 * density_cal$DIA[i]^2))))
        }
        density_cal$CCF_t[i] <- CCF_t
      }
      
      density_cal <- density_cal %>%
        group_by(PLT_CN,SUBP,Year) %>%
        mutate(PCCF = sum(CCF_t * (TPA_UNADJ * 4), na.rm = TRUE))
      
      #stand CCF = sum(CCFt on a plot) on a per acre basis
      #TPA measured on a plot/stand level
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(CCF = sum(CCF_t * TPA_UNADJ,na.rm = TRUE))
      
      #bal
      density_cal <- density_cal %>%
        mutate(BA_pa = ((DIA^2) * 0.005454) * TPA_UNADJ)
      
      #rank trees per year per plot
      #sum BApa of trees larger on the same plot in same year
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(rank_pltyr = rank(DIA, na.last = TRUE, ties.method = "min")) %>%
        #min assigns lowest value to ties (1,2,3,3,5,6)
        mutate(BAL = map_dbl(DIA,~sum(BA_pa[DIA>.x],na.rm = TRUE)))
      
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(SDI = sum(TPA_UNADJ*(DIA/10)^1.6), #stage
               num_t = length(unique(TRE_CN)))
      
      #filter for focal trees
      plt_yr2_df <- density_cal %>%
        filter(TRE_CN %in% plt_yr_df$TRE_CN)
      
      #cr
      for(i in 1:nrow(plt_yr2_df)){
        #Function arguments:
        #SPCD - is number code of species of tree record
        #SDI - is SDI of stand (Stage 1968)
        Species <- plt_yr2_df$SPCD[i]
        #SDI max values for each species were pulled from UT Variant overview
        SDIMAX <- ifelse(is.na(plt_yr2_df$SDImax[i]),
                         CR_fvs_df$SDIMAX[CR_fvs_df$species == Species],
                         plt_yr2_df$SDImax[i])
        #Calculate relative density
        RD <- plt_yr2_df$SDI[i]/SDIMAX
        
        #Calculate average stand crown ratio (ACR) for each species in the stand
        d0 <- CR_fvs_df$d0[CR_fvs_df$species == Species]
        d1 <- CR_fvs_df$d1[CR_fvs_df$species == Species]
        ACR <- d0 + d1 * RD * 100
        
        #Parameters of Weibull distribution: A,B,C
        a0 <- CR_fvs_df$a0[CR_fvs_df$species == Species]
        b0 <- CR_fvs_df$b0[CR_fvs_df$species == Species]
        b1 <- CR_fvs_df$b1[CR_fvs_df$species == Species]
        c0 <- CR_fvs_df$c0[CR_fvs_df$species == Species]
        c1 <- CR_fvs_df$c1[CR_fvs_df$species == Species]
        
        #A parameter
        WEIBA <-a0
        #B parameter
        WEIBB <- b0 + b1*ACR
        #C parameter
        WEIBC <- c0 + c1*ACR
        
        #Function arguments:
        
        #CCF - crown competition factor of stand
        #rank_pltyr - tree's rank in diameter distribution by plot by year
        #N  - number of records in the stand by year
        
        #Calculate scale parameter
        SCALE = (1.0 - .00167 * (plt_yr2_df$CCF[i]-100.0))
        if(SCALE < 0.3){SCALE = 0.3}
        if(SCALE > 1.0){SCALE = 1.0}
        
        N <- plt_yr2_df$num_t[i]
        #X is tree's rank in diameter distribution
        #Multiply tree's rank in diameter distribution (trees position relative to tree with largest diameter in the stand) by scale parameter
        Y <- plt_yr2_df$rank_pltyr[i]/N * SCALE
        if(Y < 0.05){Y = 0.05}
        if(Y > 0.95){Y = 0.95}
        #Constrain Y between 0.05 and 0.95 - crown ratio predictions in FVS are bound between these two values
        
        #Calculate crown ratio (this corresponds to variable X in UTAH variant overview)
        X <- WEIBA + WEIBB*((-1*log(1-Y))^(1/WEIBC))
        #X = a tree’s crown ratio expressed as a percent / 10
        CR_fvs <- X * 10
        
        #get CR the year before
        TRE_CN <- plt_yr2_df$TRE_CN[i]
        #growthyr is still previous year
        CR_1 <- plt_df$CR_fvs[plt_df$TRE_CN == TRE_CN & 
                                plt_df$Year == growthyr] #or CR_fvs[N] for the first round
        #bound to 1% change per year
        cr_bound1 <- CR_1 * .01
        plt_yr2_df$CR_fvs[i] <- ifelse(CR_1 > CR_fvs, 
                                          CR_1 - cr_bound1,
                                          CR_1 + cr_bound1)
      }
      
      #join with plt_df
      for(i in 1:nrow(plt_df)){
        TRE_CN <- plt_df$TRE_CN[i]
        if(plt_df$Year[i] == (growthyr + 1)){
          plt_df$DIA[i] <- plt_yr2_df$DIA[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$CCF[i] <- plt_yr2_df$CCF[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$PCCF[i] <- plt_yr2_df$PCCF[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$BAL[i] <- plt_yr2_df$BAL[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$SDI[i] <- plt_yr2_df$SDI[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$CR_fvs[i] <- plt_yr2_df$CR_fvs[plt_yr2_df$TRE_CN == TRE_CN]
        }
      }
      #add density metrics in
      
      #loop over next year
      growthyr = growthyr + 1
    }
    #join plt_df with empty data frame
    #output
    pred_df <- bind_rows(pred_df,plt_df)
    
    #loop over next plot
  }
  
  return(pred_df)
}
```

#### CR constant

```{r}
val_an_cr <- function(newdata,mod_df,mod_pp,mod_es,sp_stats,nonfocal,bratio,ccf_df,CR_fvs_df) {
  #parameters:
  #newdata - validataion trees from FIADB
  newdata_rep <- newdata %>%
    ungroup() %>%
    dplyr::select(PLT_CN, TRE_CN, SPCD, SUBP, MEASYEAR, 
                  TPA_UNADJ, DESIGNCD, tCONDID, census_int,
                  ASPECT,SLOPE,sin,cos,LAT,LON,ELEV,
                  FVS_LOC_CD,SDImax,SICOND_c,solrad_MayAug, fMEASYEAR, fDIA,
                  CR_fvs) %>%
    mutate(Year = NA,
           DIA = NA,
           CCF = NA,
           PCCF = NA,
           BAL = NA,
           SDI = NA)
  newdata_rep <- newdata_rep %>% 
    group_by(TRE_CN) %>%
    slice(rep(1:n(), each = census_int+1)) %>%
    mutate(Year = (MEASYEAR[1]:fMEASYEAR[1])) %>% #repeated data frame ready  to fill in
    ungroup()
  ##density for new data in MEASYEAR will already be calculated
  #fill in DIA,CCF, PCCF, BAL, SDI, CR_fvs, where year = measyear
  for(i in 1:nrow(newdata_rep)){
    TRE_CN <- newdata_rep$TRE_CN[i]
    if(newdata_rep$Year[i] == newdata_rep$MEASYEAR[i]){
      newdata_rep$DIA[i] <- newdata$DIA[newdata$TRE_CN == TRE_CN]
      newdata_rep$CCF[i] <- newdata$CCF[newdata$TRE_CN == TRE_CN]
      newdata_rep$PCCF[i] <- newdata$PCCF[newdata$TRE_CN == TRE_CN]
      newdata_rep$BAL[i] <- newdata$BAL[newdata$TRE_CN == TRE_CN]
      newdata_rep$SDI[i] <- newdata$SDI[newdata$TRE_CN == TRE_CN]
    }
  }
  #mod_obj - list of model objects for each species
  #sp_stats - list of species statistics (mean and standard deviation) for each covariate
  ##will be used to standardize newdata covariates
  #nonfocal - trees on the same plot as validation trees
  nonfocal <- nonfocal %>%
    ungroup()
  ##will be used to compute density parameters
  #bratio - dataframe of bark ratio constants for equation
  #ccf - dataframe of crown competiton factor constants for equation
  #CR_fvs_df - dataframe of crown ratio constants for equation
  
  #empty dataframe to add results
  pred_df <- newdata_rep[FALSE,]
  
  # loop over plot
  # to calculate density after MEASYR
  for(i in unique(newdata_rep$PLT_CN)) {
    #create plot dataframe to predict growth
    plt_df <- newdata_rep[newdata_rep$PLT_CN == i,]
    #assign projection start year
    growthyr <- plt_df$MEASYEAR[1] # assumes all trees on a plot have same MEASYEAR
    while (growthyr <= (plt_df$fMEASYEAR[1]-1)){ #stops the year before fMEASYEAR
      #filter dataframe for year of projection
      plt_yr_df <- plt_df %>%
        filter(Year == growthyr)
      
      for(i in 1:nrow(plt_yr_df)) {#for each tree on plot in given year
        Species <- plt_yr_df$SPCD[i]
        TRE_CN <- plt_yr_df$TRE_CN[i]
        
        #select model to predict growth
        #models are species specific
        if(Species == 202){mod_obj <- mod_df} 
        if(Species == 122){mod_obj <- mod_pp} 
        if(Species == 93){mod_obj <- mod_es} 
        
        #standardize covariates
        #get mean/sd for each species
        if(Species == 202){para_std <- sp_stats$sp_202}
        if(Species == 122){para_std <- sp_stats$sp_122}
        if(Species == 93) {para_std <- sp_stats$sp_93}

        #first row is mean, second row is sd
        #the inputs of the equation are from a list so output needs to be unlisted
        plt_yr_df$z.DIA_C[i] = unlist((plt_yr_df[i,"DIA"] - para_std[1,"DIA_C"]) / para_std[2,"DIA_C"])
        plt_yr_df$z.CR_fvs[i] = unlist((plt_yr_df[i,"CR_fvs"] - para_std[1,"CR_fvs"]) / para_std[2,"CR_fvs"])
        plt_yr_df$z.BAL[i] = unlist((plt_yr_df[i,"BAL"] - para_std[1,"BAL"]) / para_std[2,"BAL"])
        plt_yr_df$z.CCF[i] = unlist((plt_yr_df[i,"CCF"] - para_std[1,"CCF"]) / para_std[2,"CCF"])
        plt_yr_df$z.PCCF[i] = unlist((plt_yr_df[i,"PCCF"] - para_std[1,"PCCF"]) / para_std[2,"PCCF"])
        plt_yr_df$z.SDI[i] = unlist((plt_yr_df[i,"SDI"] - para_std[1,"SDI"]) / para_std[2,"SDI"])
        plt_yr_df$z.SICOND[i] = unlist((plt_yr_df[i,"SICOND_c"] - para_std[1,"SICOND"]) / para_std[2,"SICOND"])
        plt_yr_df$z.SLOPE[i] = unlist((plt_yr_df[i,"SLOPE"] - para_std[1,"SLOPE"]) / para_std[2,"SLOPE"])
        plt_yr_df$z.sin[i] = unlist((plt_yr_df[i,"sin"] - para_std[1,"sin"]) / para_std[2,"sin"])
        plt_yr_df$z.cos[i] = unlist((plt_yr_df[i,"cos"] - para_std[1,"cos"]) / para_std[2,"cos"])
        plt_yr_df$z.solrad_MayAug[i] = unlist((plt_yr_df[i,"solrad_MayAug"] - para_std[1,"solrad_MayAug"]) / para_std[2,"solrad_MayAug"])
        #TODO there must be a better way to do this? for loop?

        #predict
        # modobj will change with different species
        plt_yr_df$log_dds[i] <- predict(object = mod_obj, newdata = plt_yr_df[i,], 
                                        re.form = NA, type = "response")
        #re.form specify random effects to include
        ##NA include none
        
        #see page 53 of prognosis model
        #DG = sqrt((DBH/k)^2 + dds) - (DBH/k)
        # k = 1/BRATIO
        #see UT variant guide
        #BRATIO = b1+b2/(DBH^exp)
        b1 <- bratio$b1[bratio$species == Species]
        b2 <- bratio$b2[bratio$species == Species]
        exp <- bratio$exp[bratio$species == Species]
        BRATIO <- b1 + b2/(plt_yr_df$DIA[i]^exp) 
        #exp determines if use equation 4.2.1/3 or 4.2.2 in UT variant guide
        k <- 1/BRATIO 
        #DG = sqrt((DBH/k)^2 + dds - (DBH/k))
        plt_yr_df$DG[i] <- k * (sqrt((plt_yr_df$DIA[i]/k)^2 + exp(plt_yr_df$log_dds[i])) -
                                  (plt_yr_df$DIA[i]/k))
      }
      
      #so DBH0 + k*DG = DBH
      plt_yr2_df <- plt_df %>%
        filter(Year == (growthyr+1))%>%
        mutate(DIA = plt_yr_df$DIA + plt_yr_df$DG)
      
      #join with nonfocal
      #fitler for trees on plots in validation set in same year
      non_foc_filt <- nonfocal %>%
        dplyr::select(PLT_CN, TRE_CN, SUBP, SPCD,TPA_UNADJ,Year,DIA_int) %>%
        mutate(DIA = DIA_int) %>%
        filter(PLT_CN == plt_yr2_df$PLT_CN[1],
               Year == plt_yr2_df$Year[1])
      #join
      density_cal <- bind_rows(plt_yr2_df,non_foc_filt)
      
      #compute density parameters
      #ccf
      for(i in 1:nrow(density_cal)){
        Species <- density_cal$SPCD[i]
        r1 <- ccf_df$r1[ccf_df$species == Species]
        r2 <- ccf_df$r2[ccf_df$species == Species]
        r3 <- ccf_df$r3[ccf_df$species == Species]
        r4 <- ccf_df$r4[ccf_df$species == Species]
        r5 <- ccf_df$r5[ccf_df$species == Species]
        dbrk <- ccf_df$dbrk[ccf_df$species == Species]
        if(Species == 475){
          ifelse(density_cal$DIA[i] < dbrk,
                 CCF_t <- density_cal$DIA[i]*(r1+r2+r3),
                 CCF_t <- r1 + (r2 * density_cal$DIA[i]) + (r3 * density_cal$DIA[i]^2))
        }
        if(Species != 475){
          ifelse(is.na(density_cal$DIA[i]), 
                 CCF_t <- NA,
                 ifelse(density_cal$DIA[i] <= 0.1, 
                        CCF_t <- 0.0001,
                        ifelse(density_cal$DIA[i] < dbrk, 
                               CCF_t <- r4 * (density_cal$DIA[i]^r5),
                               CCF_t <- r1 + (r2 * density_cal$DIA[i]) + (r3 * density_cal$DIA[i]^2))))
        }
        density_cal$CCF_t[i] <- CCF_t
      }
      
      density_cal <- density_cal %>%
        group_by(PLT_CN,SUBP,Year) %>%
        mutate(PCCF = sum(CCF_t * (TPA_UNADJ * 4), na.rm = TRUE))
      
      #stand CCF = sum(CCFt on a plot) on a per acre basis
      #TPA measured on a plot/stand level
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(CCF = sum(CCF_t * TPA_UNADJ,na.rm = TRUE))
      
      #bal
      density_cal <- density_cal %>%
        mutate(BA_pa = ((DIA^2) * 0.005454) * TPA_UNADJ)
      
      #rank trees per year per plot
      #sum BApa of trees larger on the same plot in same year
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(rank_pltyr = rank(DIA, na.last = TRUE, ties.method = "min")) %>%
        #min assigns lowest value to ties (1,2,3,3,5,6)
        mutate(BAL = map_dbl(DIA,~sum(BA_pa[DIA>.x],na.rm = TRUE)))
      
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(SDI = sum(TPA_UNADJ*(DIA/10)^1.6), #stage
               num_t = length(unique(TRE_CN)))
      
      #filter for focal trees
      plt_yr2_df <- density_cal %>%
        filter(TRE_CN %in% plt_yr_df$TRE_CN)

      #join with plt_df
      for(i in 1:nrow(plt_df)){
        TRE_CN <- plt_df$TRE_CN[i]
        if(plt_df$Year[i] == (growthyr + 1)){
          plt_df$DIA[i] <- plt_yr2_df$DIA[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$CCF[i] <- plt_yr2_df$CCF[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$PCCF[i] <- plt_yr2_df$PCCF[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$BAL[i] <- plt_yr2_df$BAL[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$SDI[i] <- plt_yr2_df$SDI[plt_yr2_df$TRE_CN == TRE_CN]
        }
      }
      #add density metrics in
      
      #loop over next year
      growthyr = growthyr + 1
    }
    #join plt_df with empty data frame
    #output
    pred_df <- bind_rows(pred_df,plt_df)
    
    #loop over next plot
  }

  return(pred_df)
}
```

```{r}
val_clim_cr <- function(newdata,mod_df,mod_pp,mod_es,sp_stats,nonfocal,bratio,ccf_df,climate) {
  #parameters:
  #newdata - validataion trees from FIADB
  newdata_rep <- newdata %>%
    ungroup() %>%
    dplyr::select(PLT_CN, TRE_CN, SPCD, SUBP, MEASYEAR, 
                  TPA_UNADJ, DESIGNCD, tCONDID, census_int,
                  ASPECT,SLOPE,sin,cos,LAT,LON,ELEV,
                  FVS_LOC_CD,SDImax,SICOND_c,solrad_MayAug, fMEASYEAR, fDIA,
                  CR) %>%
    mutate(Year = NA,
           DIA = NA,
           CCF = NA,
           PCCF = NA,
           BAL = NA,
           SDI = NA)
  newdata_rep <- newdata_rep %>% 
    group_by(TRE_CN) %>%
    slice(rep(1:n(), each = census_int+1)) %>%
    mutate(Year = (MEASYEAR[1]:fMEASYEAR[1])) %>% #repeated data frame ready  to fill in
    ungroup()
  ##density for new data in MEASYEAR will already be calculated
  #fill in DIA,CCF, PCCF, BAL, SDI, CR_fvs, where year = measyear
  #fill climate
  climate <- climate %>%
    ungroup()
  for(i in 1:nrow(newdata_rep)){
    TRE_CN <- newdata_rep$TRE_CN[i]
    if(newdata_rep$Year[i] == newdata_rep$MEASYEAR[i]){
      newdata_rep$DIA[i] <- newdata$DIA[newdata$TRE_CN == TRE_CN]
      newdata_rep$CCF[i] <- newdata$CCF[newdata$TRE_CN == TRE_CN]
      newdata_rep$PCCF[i] <- newdata$PCCF[newdata$TRE_CN == TRE_CN]
      newdata_rep$BAL[i] <- newdata$BAL[newdata$TRE_CN == TRE_CN]
      newdata_rep$SDI[i] <- newdata$SDI[newdata$TRE_CN == TRE_CN]
    }
    #add climate
    #match over tree and year
    newdata_rep$ppt_pJunSep[i] <- climate$ppt_pJunSep[climate$TRE_CN == TRE_CN &
                                                        climate$Year == newdata_rep$Year[i]]
    newdata_rep$tmax_JunAug[i] <- climate$tmax_JunAug[climate$TRE_CN == TRE_CN &
                                                        climate$Year == newdata_rep$Year[i]]
    newdata_rep$tmax_FebJul[i] <- climate$tmax_FebJul[climate$TRE_CN == TRE_CN &
                                                        climate$Year == newdata_rep$Year[i]]
    newdata_rep$tmax_pAug[i] <- climate$tmax_pAug[climate$TRE_CN == TRE_CN &
                                                    climate$Year == newdata_rep$Year[i]]
  }
  
  #mod_obj - list of model objects for each species
  #sp_stats - list of species statistics (mean and standard deviation) for each covariate
  ##will be used to standardize newdata covariates
  #nonfocal - trees on the same plot as validation trees
  nonfocal <- nonfocal %>%
    ungroup()
  ##will be used to compute density parameters
  #bratio - dataframe of bark ratio constants for equation
  #ccf - dataframe of crown competiton factor constants for equation
  #CR_fvs_df - dataframe of crown ratio constants for equation
  #climate - dataframe of climate variables (ppt & tmax) for each tree
  
  #empty dataframe to add results
  pred_df <- newdata_rep[FALSE,]
  
  # loop over plot
  # to calculate density after MEASYR
  for(i in unique(newdata_rep$PLT_CN)) {
    #create plot dataframe to predict growth
    plt_df <- newdata_rep[newdata_rep$PLT_CN == i,]
    #assign projection start year
    growthyr <- plt_df$MEASYEAR[1] # assumes all trees on a plot have same MEASYEAR
    while (growthyr <= (plt_df$fMEASYEAR[1]-1)){ #stops the year before fMEASYEAR
      #filter dataframe for year of projection
      plt_yr_df <- plt_df %>%
        filter(Year == growthyr)
      
      for(i in 1:nrow(plt_yr_df)) {#for each tree on plot in given year
        Species <- plt_yr_df$SPCD[i]
        TRE_CN <- plt_yr_df$TRE_CN[i]
        
        #select model to predict growth
        #models are species specific
        if(Species == 202){mod_obj <- mod_df} 
        if(Species == 122){mod_obj <- mod_pp} 
        if(Species == 93){mod_obj <- mod_es} 
        
        #standardize covariates
        #get mean/sd for each species
        if(Species == 202){para_std <- sp_stats$sp_202}
        if(Species == 122){para_std <- sp_stats$sp_122}
        if(Species == 93) {para_std <- sp_stats$sp_93}
        
        #first row is mean, second row is sd
        #the inputs of the equation are from a list so output needs to be unlisted
        plt_yr_df$z.DIA_C[i] = unlist((plt_yr_df[i,"DIA"] - para_std[1,"DIA_C"]) / para_std[2,"DIA_C"])
        plt_yr_df$z.CR[i] = unlist((plt_yr_df[i,"CR"] - para_std[1,"CR"]) / para_std[2,"CR"])
        plt_yr_df$z.BAL[i] = unlist((plt_yr_df[i,"BAL"] - para_std[1,"BAL"]) / para_std[2,"BAL"])
        plt_yr_df$z.CCF[i] = unlist((plt_yr_df[i,"CCF"] - para_std[1,"CCF"]) / para_std[2,"CCF"])
        plt_yr_df$z.PCCF[i] = unlist((plt_yr_df[i,"PCCF"] - para_std[1,"PCCF"]) / para_std[2,"PCCF"])
        plt_yr_df$z.SDI[i] = unlist((plt_yr_df[i,"SDI"] - para_std[1,"SDI"]) / para_std[2,"SDI"])
        plt_yr_df$z.SICOND[i] = unlist((plt_yr_df[i,"SICOND_c"] - para_std[1,"SICOND"]) / para_std[2,"SICOND"])
        plt_yr_df$z.SLOPE[i] = unlist((plt_yr_df[i,"SLOPE"] - para_std[1,"SLOPE"]) / para_std[2,"SLOPE"])
        plt_yr_df$z.sin[i] = unlist((plt_yr_df[i,"sin"] - para_std[1,"sin"]) / para_std[2,"sin"])
        plt_yr_df$z.cos[i] = unlist((plt_yr_df[i,"cos"] - para_std[1,"cos"]) / para_std[2,"cos"])
        plt_yr_df$z.solrad_MayAug[i] = unlist((plt_yr_df[i,"solrad_MayAug"] - para_std[1,"solrad_MayAug"]) / para_std[2,"solrad_MayAug"])
        plt_yr_df$z.ppt_pJunSep[i] = unlist((plt_yr_df[i,"ppt_pJunSep"] - 
                                               para_std[1,"ppt_pJunSep"]) / para_std[2,"ppt_pJunSep"])
        #temperature different for each species
        sp_202 <- sp_stats$sp_202
        sp_122 <- sp_stats$sp_122
        sp_93 <- sp_stats$sp_93
        plt_yr_df$z.tmax_FebJul[i] = unlist((plt_yr_df[i,"tmax_FebJul"] -
                                               sp_202[1,"tmax_FebJul"]) /
                                              sp_202[2,"tmax_FebJul"])
        plt_yr_df$z.tmax_JunAug[i] = unlist((plt_yr_df[i,"tmax_JunAug"] -
                                               sp_122[1,"tmax_JunAug"]) /
                                              sp_122[2,"tmax_JunAug"])
        plt_yr_df$z.tmax_pAug[i] = unlist((plt_yr_df[i,"tmax_pAug"] -
                                             sp_93[1,"tmax_pAug"]) / 
                                            sp_93[2,"tmax_pAug"])
        #TODO there must be a better way to do this? for loop?
        
        #predict
        # modobj will change with different species
        plt_yr_df$log_dds[i] <- predict(object = mod_obj, newdata = plt_yr_df[i,], 
                                        re.form = NA, type = "response")
        #re.form specify random effects to include
        ##NA include none
        
        #see page 53 of prognosis model
        #DG = sqrt((DBH/k)^2 + dds) - (DBH/k)
        # k = 1/BRATIO
        #see UT variant guide
        #BRATIO = b1+b2/(DBH^exp)
        b1 <- bratio$b1[bratio$species == Species]
        b2 <- bratio$b2[bratio$species == Species]
        exp <- bratio$exp[bratio$species == Species]
        BRATIO <- b1 + b2/(plt_yr_df$DIA[i]^exp) 
        #exp determines if use equation 4.2.1/3 or 4.2.2 in UT variant guide
        k <- 1/BRATIO 
        #DG = sqrt((DBH/k)^2 + dds - (DBH/k))
        plt_yr_df$DG[i] <- k * (sqrt((plt_yr_df$DIA[i]/k)^2 + exp(plt_yr_df$log_dds[i])) -
                                  (plt_yr_df$DIA[i]/k))
      }
      
      #so DBH0 + k*DG = DBH
      plt_yr2_df <- plt_df %>%
        filter(Year == (growthyr+1))%>%
        mutate(DIA = plt_yr_df$DIA + plt_yr_df$DG)
      
      #join with nonfocal
      #fitler for trees on plots in validation set in same year
      non_foc_filt <- nonfocal %>%
        dplyr::select(PLT_CN, TRE_CN, SUBP, SPCD,TPA_UNADJ,Year,DIA_int) %>%
        mutate(DIA = DIA_int) %>%
        filter(PLT_CN == plt_yr2_df$PLT_CN[1],
               Year == plt_yr2_df$Year[1])
      #join
      density_cal <- bind_rows(plt_yr2_df,non_foc_filt)
      
      #compute density parameters
      #ccf
      for(i in 1:nrow(density_cal)){
        Species <- density_cal$SPCD[i]
        r1 <- ccf_df$r1[ccf_df$species == Species]
        r2 <- ccf_df$r2[ccf_df$species == Species]
        r3 <- ccf_df$r3[ccf_df$species == Species]
        r4 <- ccf_df$r4[ccf_df$species == Species]
        r5 <- ccf_df$r5[ccf_df$species == Species]
        dbrk <- ccf_df$dbrk[ccf_df$species == Species]
        if(Species == 475){
          ifelse(density_cal$DIA[i] < dbrk,
                 CCF_t <- density_cal$DIA[i]*(r1+r2+r3),
                 CCF_t <- r1 + (r2 * density_cal$DIA[i]) + (r3 * density_cal$DIA[i]^2))
        }
        if(Species != 475){
          ifelse(is.na(density_cal$DIA[i]), 
                 CCF_t <- NA,
                 ifelse(density_cal$DIA[i] <= 0.1, 
                        CCF_t <- 0.0001,
                        ifelse(density_cal$DIA[i] < dbrk, 
                               CCF_t <- r4 * (density_cal$DIA[i]^r5),
                               CCF_t <- r1 + (r2 * density_cal$DIA[i]) + (r3 * density_cal$DIA[i]^2))))
        }
        density_cal$CCF_t[i] <- CCF_t
      }
      
      density_cal <- density_cal %>%
        group_by(PLT_CN,SUBP,Year) %>%
        mutate(PCCF = sum(CCF_t * (TPA_UNADJ * 4), na.rm = TRUE))
      
      #stand CCF = sum(CCFt on a plot) on a per acre basis
      #TPA measured on a plot/stand level
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(CCF = sum(CCF_t * TPA_UNADJ,na.rm = TRUE))
      
      #bal
      density_cal <- density_cal %>%
        mutate(BA_pa = ((DIA^2) * 0.005454) * TPA_UNADJ)
      
      #rank trees per year per plot
      #sum BApa of trees larger on the same plot in same year
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(rank_pltyr = rank(DIA, na.last = TRUE, ties.method = "min")) %>%
        #min assigns lowest value to ties (1,2,3,3,5,6)
        mutate(BAL = map_dbl(DIA,~sum(BA_pa[DIA>.x],na.rm = TRUE)))
      
      density_cal <- density_cal %>%
        group_by(PLT_CN,Year) %>%
        mutate(SDI = sum(TPA_UNADJ*(DIA/10)^1.6), #stage
               num_t = length(unique(TRE_CN)))
      
      #filter for focal trees
      plt_yr2_df <- density_cal %>%
        filter(TRE_CN %in% plt_yr_df$TRE_CN)
      
      #join with plt_df
      for(i in 1:nrow(plt_df)){
        TRE_CN <- plt_df$TRE_CN[i]
        if(plt_df$Year[i] == (growthyr + 1)){
          plt_df$DIA[i] <- plt_yr2_df$DIA[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$CCF[i] <- plt_yr2_df$CCF[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$PCCF[i] <- plt_yr2_df$PCCF[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$BAL[i] <- plt_yr2_df$BAL[plt_yr2_df$TRE_CN == TRE_CN]
          plt_df$SDI[i] <- plt_yr2_df$SDI[plt_yr2_df$TRE_CN == TRE_CN]
        }
      }
      #add density metrics in
      
      #loop over next year
      growthyr = growthyr + 1
    }
    #join plt_df with empty data frame
    #output
    pred_df <- bind_rows(pred_df,plt_df)
    
    #loop over next plot
  }
  
  return(pred_df)
}

```

### Predict

```{r}
#load validation trees
load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/val_dset.Rdata")
#load other trees on plot
load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/non_focal.Rdata")
```

Predict growth using annualized with tree rings only models for each species.

```{r}
pred_an_full <- val_an(newdata = val_dset,mod_df = an_al_df, mod_pp = an_al_pp, 
                              mod_es = an_al_es,sp_stats = sp_stats,nonfocal = non_focal,
                              bratio = bratio_df ,ccf_df = ccf_df,CR_fvs_df = CR_fvs_df)
```

```{r}
pred_an <- val_an(newdata = val_dset,mod_df = an_red_df, mod_pp = an_red_pp, 
                              mod_es = an_red_es,sp_stats = sp_stats,nonfocal = non_focal,
                              bratio = bratio_df ,ccf_df = ccf_df,CR_fvs_df = CR_fvs_df)
```

Predict growth using annualized with tree rings and climate models for each species.

```{r}
#load climate
load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/val_clim.Rdata")
```

```{r}
pred_clim_full <- val_an_clim(newdata = val_dset,mod_df = clim_al_df, mod_pp = clim_al_pp, 
                              mod_es = clim_al_es,sp_stats = sp_stats,nonfocal = non_focal,
                              bratio = bratio_df ,ccf_df = ccf_df,CR_fvs_df = CR_fvs_df, climate = val_clim)
```

```{r}
pred_clim <- val_an_clim(newdata = val_dset,mod_df = clim_red_df, mod_pp = clim_red_pp, 
                              mod_es = clim_red_es,sp_stats = sp_stats,nonfocal = non_focal,
                              bratio = bratio_df ,ccf_df = ccf_df,CR_fvs_df = CR_fvs_df, climate = val_clim)
```

```{r}
#save
save(pred_an_full,file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/pred_an_full.Rdata")
save(pred_an,file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/pred_an.Rdata")
save(pred_clim_full,file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/pred_clim_full.Rdata")
save(pred_clim,file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/pred_clim.Rdata")
```


# Explore 

## Explore covariates

```{r}
#look at a single tree over time
bal_yr_plots <- pred_clim%>%
  group_by(TRE_CN) %>%
  do(plots=ggplot(data=.) +
       aes(x=DIA, y=BAL) + geom_point() + ggtitle(unique(.$TRE_CN)))

par(mfrow=c(2,2))
bal_yr_plots$plots[[10]]
bal_yr_plots$plots[[20]]
bal_yr_plots$plots[[40]]
bal_yr_plots$plots[[70]]
```

```{r}
#cr
pred_clim_2 <- pred_clim %>%
  group_by(TRE_CN) %>%
  filter(Year == MEASYEAR | Year == MEASYEAR + 1) %>%
  mutate(cr_change = lag(CR_fvs) - CR_fvs)
hist(pred_clim_2$cr_change, breaks = 50,
     xlab = "CR(t) - CR(t+1)")

pred_clim_2 <- pred_clim %>%
  group_by(TRE_CN) %>%
  filter(Year == MEASYEAR | Year == fMEASYEAR) %>%
  mutate(cr_change = lag(CR_fvs) - CR_fvs)
hist(pred_clim_2$cr_change, breaks = 50,
     xlab = "CR(start) - CR(end)", main = "Weibull Distribution")

hist((val_dset$CR_fvs - val_dset$fCR), breaks = 50,
     xlab = "CR(start) - CR(end)", main = "Observed")

##fvs
hist((fvs_check_red$PctCr - fvs_check_red$CR2), breaks = 50,
     xlab = "CR(start) - CR(end)", main = "FVS")

val_dset$PctCR <- fvs_check_red$PctCr[match(val_dset$TRE_CN,fvs_check_red$TRE_CN)]
plot(val_dset$CR_fvs,val_dset$PctCR,
     xlab = "Observed CR", ylab = "FVS CR")


```

```{r}
#bal
val_dset$PtBAL <- fvs_check_red$PtBAL[match(val_dset$TRE_CN,fvs_check_red$TRE_CN)]

val_dset$BAL <- density_val$BAL[match(val_dset$TRE_CN,density_val$TRE_CN)]
plot(val_dset$BAL,val_dset$PtBAL,
     xlab = "My BAL", ylab = "FVS BAL",
     main = "Plot-level")

val_dset$BAL_s <- density_val$BAL_s[match(val_dset$TRE_CN,density_val$TRE_CN)]
plot(val_dset$BAL_s,val_dset$PtBAL,
     xlab = "My BAL", ylab = "FVS BAL",
     main = "Subplot/point-level")

val_dset$BAL_sc <- density_val$BAL_sc[match(val_dset$TRE_CN,density_val$TRE_CN)]
plot(val_dset$BAL_sc,val_dset$PtBAL,
     xlab = "My BAL", ylab = "FVS BAL",
     main = "Subplot/point-level & Scaled")
```


Compare predictions to observations

## Annual

```{r}
pred_an_full <- pred_an_full %>%
  group_by(TRE_CN) %>%
  mutate(DG_pred = max(DIA) - min(DIA),
         DG_obs = fDIA - min(DIA))
pred_fan_fmy <- pred_an_full %>%
  filter(Year == fMEASYEAR)
par(mfrow=c(1,2))
plot(pred_fan_fmy$DIA,pred_fan_fmy$fDIA,
     xlab = "Predicted", ylab = "Observed",
     main = "DBH - Full: Tree Rings")
plot(pred_fan_fmy$DG_pred,pred_fan_fmy$DG_obs,
     xlab = "Predicted", ylab = "Observed",
     main = "DG - Full: Tree Rings")
fit_fan <- lm(fDIA~DIA, data = pred_fan_fmy)
summary(fit_fan)
sqrt(mean(fit_fan$residuals^2))
fit_fan_dg <- lm(DG_obs~DG_pred, data = pred_fan_fmy)
summary(fit_fan_dg)
sqrt(mean(fit_fan_dg$residuals^2))
```


```{r}
pred_an <- pred_an %>%
  group_by(TRE_CN) %>%
  mutate(DG_pred = max(DIA) - min(DIA),
         DG_obs = fDIA - min(DIA))
pred_an_fmy <- pred_an %>%
  filter(Year == fMEASYEAR)
par(mfrow=c(1,2))
plot(pred_an_fmy$DIA,pred_an_fmy$fDIA,
     xlab = "Predicted", ylab = "Observed",
     main = "DBH - Reduced: Tree Rings")
plot(pred_an_fmy$DG_pred,pred_an_fmy$DG_obs,
     xlab = "Predicted", ylab = "Observed",
     main = "DG - Reduced: Tree Rings")
fit_an <- lm(fDIA~DIA, data = pred_an_fmy)
summary(fit_an)
sqrt(mean(fit_an$residuals^2))
fit_an_dg <- lm(DG_obs~DG_pred, data = pred_an_fmy)
summary(fit_an_dg)
sqrt(mean(fit_an_dg$residuals^2))
```

### Residuals

#### Full

```{r}
pred_fan_fmy <- pred_fan_fmy %>%
  mutate(diff = DIA - fDIA)
par(mfrow=c(2,2))
hist(pred_fan_fmy$diff, breaks = 50,main = "Histogram",xlab= "Residuals")
qqnorm(pred_fan_fmy$diff)
qqline(pred_fan_fmy$diff)
plot(pred_fan_fmy$DIA,pred_fan_fmy$diff, xlab = "predicted", ylab= "residuals")
```


```{r}
#merge with climate normals
n_ppt <- read.csv("/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/n_ppt_extr.csv")
n_tmp <- read.csv("/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/n_tmp_extr.csv")
n_tmx <- read.csv("/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/n_tmx_extr.csv")
```

```{r}
#calculate anomalies
#get total/average climate variable during projection cycle for each tree
val_clim_red <- val_clim %>%
  mutate(ppt_an = ppt_Jan+ppt_Feb+ppt_Mar+ppt_Apr+ppt_May+ppt_Jun
         +ppt_Jul+ppt_Aug+ppt_Sep+ppt_Oct+ppt_Nov+ppt_Dec,
         tmx_an = (tmax_Jan+tmax_Feb+tmax_Mar+tmax_Apr+tmax_May+tmax_Jun
         +tmax_Jul+tmax_Aug+tmax_Sep+tmax_Oct+tmax_Nov+tmax_Dec)/12) %>%
  select(TRE_CN,Year,ppt_an,tmx_an)
pred_an_full <- left_join(pred_an_full,val_clim_red)

#get 30 year normals
pred_an_full$n_ppt <- n_ppt$normalspptNormals[match(pred_an_full$TRE_CN,n_ppt$TRE_CN)]
pred_an_full$n_tmx <- n_tmx$normalstmxNormals[match(pred_an_full$TRE_CN,n_tmx$TRE_CN)]

#calculate anomalies
pred_an_full<- pred_an_full %>%
  group_by(TRE_CN) %>%
  mutate(ppt_an_m = mean(ppt_an),
         tmx_an_m = mean(tmx_an),
         ppt_diff_av = mean(ppt_an) - n_ppt,
         ppt_av_diff = mean(ppt_an - n_ppt),
         tmx_diff_av = mean(tmx_an) - n_tmx,
         tmx_av_diff = mean(tmx_an - n_tmx))
length(unique(pred_an_full$TRE_CN[pred_an_full$ppt_diff_av == pred_an_full$ppt_av_diff]))

#determine association with residuals
pred_fan_fmy <- pred_an_full %>%
  filter(Year == fMEASYEAR) %>%
  mutate(diff = DIA - fDIA)
```

```{r}
#plot
pred_fan_fmy$SPCD <- as.factor(pred_fan_fmy$SPCD)
#map, mat
ggplot(data = pred_fan_fmy, aes(x = ppt_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Precipitation") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = pred_fan_fmy, aes(x = tmx_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Max Temperature") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
#anomalies with 30 yr normals
ggplot(data = pred_fan_fmy, aes(x = ppt_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Precipitation - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = pred_fan_fmy, aes(x = tmx_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Max Temperature - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#density
for(i in 1:nrow(pred_fan_fmy)){
  TRE_CN <- pred_fan_fmy$TRE_CN[i]
  pred_fan_fmy$SDI_1[i] <- val_dset$SDI[val_dset$TRE_CN == TRE_CN]
}
ggplot(data = pred_fan_fmy, aes(x = SDI_1,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Density (SDI)") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#forest code
ggplot(data = pred_fan_fmy, aes(x = FVS_LOC_CD,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Forest Code") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
```


#### Reduced

```{r}
#qq of residuals
qqnorm(fit_an$residuals)
qqline(fit_an$residuals)
#predicted vs residuals
pred_an_fmy$residuals <- residuals(fit_an)
plot(pred_an_fmy$DIA,pred_an_fmy$residuals, xlab = "Predicted", ylab = "Residuals")
```

```{r}
pred_an_fmy <- pred_an_fmy %>%
  mutate(diff = DIA - fDIA)
par(mfrow=c(2,2))
hist(pred_an_fmy$diff, breaks = 50, main = "Histogram",xlab= "Residuals")
qqnorm(pred_an_fmy$diff)
qqline(pred_an_fmy$diff)
plot(pred_an_fmy$DIA,pred_an_fmy$diff, xlab= "predicted", ylab = "residuals")
```

```{r}
#calculate anomalies
#get total/average climate variable during projection cycle for each tree
pred_an <- left_join(pred_an,val_clim_red)

#get 30 year normals
pred_an$n_ppt <- n_ppt$normalspptNormals[match(pred_an$TRE_CN,n_ppt$TRE_CN)]
pred_an$n_tmx <- n_tmx$normalstmxNormals[match(pred_an$TRE_CN,n_tmx$TRE_CN)]

#calculate anomalies
pred_an<- pred_an %>%
  group_by(TRE_CN) %>%
  mutate(ppt_an_m = mean(ppt_an),
         tmx_an_m = mean(tmx_an),
         ppt_diff_av = mean(ppt_an) - n_ppt,
         ppt_av_diff = mean(ppt_an - n_ppt),
         tmx_diff_av = mean(tmx_an) - n_tmx,
         tmx_av_diff = mean(tmx_an - n_tmx))

#determine association with residuals
pred_an_fmy <- pred_an %>%
  filter(Year == fMEASYEAR) %>%
  mutate(diff = DIA - fDIA)
```

```{r}
#plot
pred_an_fmy$SPCD <- as.factor(pred_an_fmy$SPCD)
#map, mat
ggplot(data = pred_an_fmy, aes(x = ppt_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Precipitation") +
  ylab("Residual") +
   scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = pred_an_fmy, aes(x = tmx_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Max Temperature") +
  ylab("Residual") +
   scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
#anomalies with 30 yr normals
ggplot(data = pred_an_fmy, aes(x = ppt_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Precipitation - 30 yr Normal") +
  ylab("Residual") +
   scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = pred_an_fmy, aes(x = tmx_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Max Temperature - 30 yr Normal") +
  ylab("Residual") +
   scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#density
for(i in 1:nrow(pred_an_fmy)){
  TRE_CN <- pred_an_fmy$TRE_CN[i]
  pred_an_fmy$SDI_1[i] <- val_dset$SDI[val_dset$TRE_CN == TRE_CN]
}
ggplot(data = pred_an_fmy, aes(x = SDI_1,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Density (SDI)") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#forest code
ggplot(data = pred_an_fmy, aes(x = FVS_LOC_CD,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Forest Code") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
```

## Climate

```{r}
pred_clim_full <- pred_clim_full %>%
  group_by(TRE_CN) %>%
  mutate(DG_pred = max(DIA) - min(DIA),
         DG_obs = fDIA - min(DIA))
pred_fclim_fmy <- pred_clim_full %>%
  filter(Year == fMEASYEAR)
par(mfrow=c(1,2))
plot(pred_fclim_fmy$DIA,pred_fclim_fmy$fDIA,
     xlab = "Predicted", ylab = "Observed",
     main = "DBH - Full: Tree-Rings + Climate")
plot(pred_fclim_fmy$DG_pred,pred_fclim_fmy$DG_obs,
     xlab = "Predicted", ylab = "Observed",
     main = "DG - Full: Tree-Rings + Climate")
fit_fclim <- lm(fDIA~DIA,data = pred_fclim_fmy)
summary(fit_fclim)
sqrt(mean(fit_fclim$residuals^2))
fit_fclim_dg <- lm(DG_obs~DG_pred,data = pred_fclim_fmy)
summary(fit_fclim_dg)
sqrt(mean(fit_fclim_dg$residuals^2))
```


```{r}
pred_clim <- pred_clim %>%
  group_by(TRE_CN) %>%
  mutate(DG_pred = max(DIA) - min(DIA),
         DG_obs = fDIA - min(DIA))
pred_rclim_fmy <- pred_clim %>%
  filter(Year == fMEASYEAR)
par(mfrow=c(1,2))
plot(pred_rclim_fmy$DIA,pred_rclim_fmy$fDIA,
     xlab = "Predicted", ylab = "Observed",
     main = "DBH")
plot(pred_rclim_fmy$DG_pred,pred_rclim_fmy$DG_obs,
     xlab = "Predicted", ylab = "Observed",
     main = "DG")
fit_rclim <- lm(fDIA~DIA,data = pred_rclim_fmy)
summary(fit_rclim)
sqrt(mean(fit_rclim$residuals^2))
fit_rclim_dg <- lm(DG_obs~DG_pred,data = pred_rclim_fmy)
summary(fit_rclim_dg)
sqrt(mean(fit_rclim_dg$residuals^2))
```

### Residuals

```{r}
#qq of residuals
qqnorm(fit_clim$residuals)
qqline(fit_clim$residuals)
#predicted vs residuals
pred_clim_fmy$residuals <- residuals(fit_clim)
plot(pred_clim_fmy$DIA,pred_an_fmy$residuals, xlab = "Predicted", ylab = "Residuals")
```

#### Full

```{r}
pred_fclim_fmy <- pred_fclim_fmy %>%
  mutate(diff = DIA - fDIA)
par(mfrow=c(2,2))
hist(pred_fclim_fmy$diff, breaks = 50, main = "Histogram",xlab= "Residuals")
qqnorm(pred_fclim_fmy$diff)
qqline(pred_fclim_fmy$diff)
plot(pred_fclim_fmy$DIA,pred_fclim_fmy$diff, xlab= "predicted", ylab = "residuals")
```


```{r}
#calculate anomalies
#get total/average climate variable during projection cycle for each tree
pred_clim_full <- left_join(pred_clim_full,val_clim_red)

#get 30 year normals
pred_clim_full$n_ppt <- n_ppt$normalspptNormals[match(pred_clim_full$TRE_CN,n_ppt$TRE_CN)]
pred_clim_full$n_tmx <- n_tmx$normalstmxNormals[match(pred_clim_full$TRE_CN,n_tmx$TRE_CN)]

#calculate anomalies
pred_clim_full <- pred_clim_full %>%
  group_by(TRE_CN) %>%
  mutate(ppt_an_m = mean(ppt_an),
         tmx_an_m = mean(tmx_an),
         ppt_diff_av = mean(ppt_an) - n_ppt,
         ppt_av_diff = mean(ppt_an - n_ppt),
         tmx_diff_av = mean(tmx_an) - n_tmx,
         tmx_av_diff = mean(tmx_an - n_tmx))

#determine association with residuals
pred_fclim_fmy <- pred_clim_full %>%
  filter(Year == fMEASYEAR) %>%
  mutate(diff = DIA - fDIA)
```

```{r}
#plot
pred_fclim_fmy$SPCD <- as.factor(pred_fclim_fmy$SPCD)
#map, mat
ggplot(data = pred_fclim_fmy, aes(x = ppt_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Precipitation") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = pred_fclim_fmy, aes(x = tmx_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Max Temperature") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
#anomalies with 30 yr normals
ggplot(data = pred_fclim_fmy, aes(x = ppt_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Precipitation - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = pred_fclim_fmy, aes(x = tmx_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Max Temperature - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#density
for(i in 1:nrow(pred_fclim_fmy)){
  TRE_CN <- pred_fclim_fmy$TRE_CN[i]
  pred_fclim_fmy$SDI_1[i] <- val_dset$SDI[val_dset$TRE_CN == TRE_CN]
}
ggplot(data = pred_fclim_fmy, aes(x = SDI_1,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Density (SDI)") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#forest code
ggplot(data = pred_fclim_fmy, aes(x = FVS_LOC_CD,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Forest Code") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
```

#### Reduced

```{r}
pred_rclim_fmy <- pred_rclim_fmy %>%
  mutate(diff = DIA - fDIA)
par(mfrow=c(2,2))
hist(pred_rclim_fmy$diff, breaks = 50, main = "Histogram",xlab= "Residuals")
qqnorm(pred_rclim_fmy$diff)
qqline(pred_rclim_fmy$diff)
plot(pred_rclim_fmy$DIA,pred_rclim_fmy$diff, xlab= "predicted", ylab = "residuals")
```

```{r}
#calculate anomalies
#get total/average climate variable during projection cycle for each tree
pred_clim <- left_join(pred_clim,val_clim_red)

#get 30 year normals
pred_clim$n_ppt <- n_ppt$normalspptNormals[match(pred_clim$TRE_CN,n_ppt$TRE_CN)]
pred_clim$n_tmx <- n_tmx$normalstmxNormals[match(pred_clim$TRE_CN,n_tmx$TRE_CN)]

#calculate anomalies
pred_clim <- pred_clim %>%
  group_by(TRE_CN) %>%
  mutate(ppt_an_m = mean(ppt_an),
         tmx_an_m = mean(tmx_an),
         ppt_diff_av = mean(ppt_an) - n_ppt,
         ppt_av_diff = mean(ppt_an - n_ppt),
         tmx_diff_av = mean(tmx_an) - n_tmx,
         tmx_av_diff = mean(tmx_an - n_tmx))

#determine association with residuals
pred_rclim_fmy <- pred_clim %>%
  filter(Year == fMEASYEAR) %>%
  mutate(diff = DIA - fDIA)
```

```{r}
#plot
pred_rclim_fmy$SPCD <- as.factor(pred_rclim_fmy$SPCD)
#map, mat
ggplot(data = pred_rclim_fmy, aes(x = ppt_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Precipitation") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = pred_rclim_fmy, aes(x = tmx_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Max Temperature") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
#anomalies with 30 yr normals
ggplot(data = pred_rclim_fmy, aes(x = ppt_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Precipitation - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = pred_rclim_fmy, aes(x = tmx_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Max Temperature - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#density
for(i in 1:nrow(pred_rclim_fmy)){
  TRE_CN <- pred_rclim_fmy$TRE_CN[i]
  pred_rclim_fmy$SDI_1[i] <- val_dset$SDI[val_dset$TRE_CN == TRE_CN]
}
ggplot(data = pred_rclim_fmy, aes(x = SDI_1,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Density (SDI)") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#forest code
ggplot(data = pred_rclim_fmy, aes(x = FVS_LOC_CD,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Forest Code") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
```

## current FVS growth model

```{r echo=FALSE}
load("/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/fvs_check_red.Rdata")
```


```{r}
#plot fvs predicted vs observed
fvs_check_red <- fvs_check_red %>%
  mutate(DG_obs = fDIA - DIA,
         DG_pred = eDBH - DIA)
par(mfrow=c(1,2))
plot(fvs_check_red$eDBH,fvs_check_red$fDIA,
     xlab = "Predicted", ylab = "Observed",
     main = "DBH - FVS")
plot(fvs_check_red$DG_pred,fvs_check_red$DG_obs,
     xlab = "Predicted", ylab = "Observed",
     main = "DG - FVS")
fit_fvs <- lm(fDIA~eDBH,data = fvs_check_red)
summary(fit_fvs)
sqrt(mean(fit_fvs$residuals^2))
fit_fvs_dg <- lm(DG_obs~DG_pred,data = fvs_check_red)
summary(fit_fvs_dg)
sqrt(mean(fit_fvs_dg$residuals^2))
```

```{r}
#calculate anomalies
#get total/average climate variable during projection cycle for each tree
for(i in 1:nrow(fvs_check_red)){
  TRE_CN <- fvs_check_red$TRE_CN[i]
  ppt_an_tre <- pred_clim$ppt_an[pred_clim$TRE_CN==TRE_CN]
  tmx_an_tre <- pred_clim$tmx_an[pred_clim$TRE_CN==TRE_CN]
  fvs_check_red$ppt_an_m[i] <- mean(ppt_an_tre)
  fvs_check_red$tmx_an_m[i] <- mean(tmx_an_tre)
}

#get 30 year normals
fvs_check_red$n_ppt <- n_ppt$normalspptNormals[match(fvs_check_red$TRE_CN,n_ppt$TRE_CN)]
fvs_check_red$n_tmx <- n_tmx$normalstmxNormals[match(fvs_check_red$TRE_CN,n_tmx$TRE_CN)]

#get anomalies
fvs_check_red$ppt_av_diff <- pred_rclim_fmy$ppt_av_diff[match(fvs_check_red$TRE_CN,pred_rclim_fmy$TRE_CN)]
fvs_check_red$tmx_av_diff <- pred_rclim_fmy$tmx_av_diff[match(fvs_check_red$TRE_CN,pred_rclim_fmy$TRE_CN)]

#determine association with residuals
fvs_check_red <- fvs_check_red %>%
  mutate(diff = eDBH - fDIA)
```

```{r}
#plot
#map, mat
ggplot(data = fvs_check_red, aes(x = ppt_an_m,y = diff)) +
  geom_point(aes(color=factor(SPCD))) +
  xlab("Mean Annual Precipitation") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = fvs_check_red, aes(x = tmx_an_m,y = diff)) +
  geom_point(aes(color=factor(SPCD))) +
  xlab("Mean Annual Max Temperature") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
#anomalies
ggplot(data = fvs_check_red, aes(x = ppt_av_diff,y = diff)) +
  geom_point(aes(color=factor(SPCD))) +
  xlab("Average Annual Precipitation - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()
ggplot(data = fvs_check_red, aes(x = tmx_av_diff,y = diff)) +
  geom_point(aes(color=factor(SPCD))) +
  xlab("Average Annual Max Temperature - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#density
for(i in 1:nrow(fvs_check_red)){
  TRE_CN <- fvs_check_red$TRE_CN[i]
  fvs_check_red$SDI_1[i] <- val_dset$SDI[val_dset$TRE_CN == TRE_CN]
}
ggplot(data = fvs_check_red, aes(x = SDI_1,y = diff)) +
  geom_point(aes(color=factor(SPCD))) +
  xlab("Density (SDI)") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()

#forest code
# ggplot(data = fvs_check_red, aes(x = FVS_LOC_CD,y = diff)) +
#   geom_point(aes(color=factor(SPCD))) +
#   xlab("Forest Code") +
#   ylab("Residual") +
#   scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
#                                  "93" = "gold1")) +
#   theme_minimal()
```

```{r}
hist(pred_fan_fmy$diff,breaks = 50,
     xlab = "Residuals",main = "Full: Tree-ring")
hist(pred_an_fmy$diff,breaks = 50,
     xlab = "Residuals",main = "Reduced: Tree-ring")
hist(pred_fclim_fmy$diff,breaks = 50,
     xlab = "Residuals",main = "Full: Tree-ring + Climate")
hist(pred_rclim_fmy$diff,breaks = 50,
     xlab = "Residuals",main = "Reduced: Tree-ring + Climate")
hist(fvs_check_red$diff,breaks = 50,
     xlab = "Residuals",main = "FVS")
```


```{r}
pred_fan_plot <- pred_fan_fmy %>%
  mutate(model = "Full: Tree-rings") %>%
  select(model,TRE_CN,SPCD,diff,ppt_an_m,tmx_an_m,ppt_av_diff,tmx_av_diff,SDI_1,FVS_LOC_CD)
pred_an_plot <- pred_an_fmy %>%
  mutate(model = "Reduced: Tree-rings") %>%
  select(model,TRE_CN,SPCD,diff,ppt_an_m,tmx_an_m,ppt_av_diff,tmx_av_diff,SDI_1,FVS_LOC_CD)
pred_fclim_plot <- pred_fclim_fmy %>%
  mutate(model = "Full: Tree-rings + Climate") %>%
  select(model,TRE_CN,SPCD,diff,ppt_an_m,tmx_an_m,ppt_av_diff,tmx_av_diff,SDI_1,FVS_LOC_CD)
pred_rclim_plot <- pred_rclim_fmy %>%
  mutate(model = "Reduced: Tree-rings + Climate") %>%
  select(model,TRE_CN,SPCD,diff,ppt_an_m,tmx_an_m,ppt_av_diff,tmx_av_diff,SDI_1,FVS_LOC_CD)
fvs_plot <- fvs_check_red %>%
  mutate(model = "FVS",
         SPCD = factor(SPCD)) %>%
  select(model,TRE_CN,SPCD,diff,ppt_an_m,tmx_an_m,ppt_av_diff,tmx_av_diff,SDI_1)
res_pmod_plot <- bind_rows(list(pred_fan_plot,pred_an_plot,pred_fclim_plot,pred_rclim_plot))
res_mod_plot <- bind_rows(list(pred_fan_plot,pred_an_plot,pred_fclim_plot,pred_rclim_plot,fvs_plot))


#plot
#map, mat
ggplot(data = res_mod_plot, aes(x = ppt_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Precipitation") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()+
  facet_wrap(~model)
ggplot(data = res_mod_plot, aes(x = tmx_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Mean Annual Max Temperature") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)
#anomalies
ggplot(data = res_mod_plot, aes(x = ppt_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Precipitation - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()+
  facet_wrap(~model)
ggplot(data = res_mod_plot, aes(x = tmx_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Average Annual Max Temperature - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)

#density
ggplot(data = res_mod_plot, aes(x = SDI_1,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Density (SDI)") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)


#forest code
ggplot(data = res_pmod_plot, aes(x = FVS_LOC_CD,y = diff)) +
  geom_point(aes(color=SPCD)) +
  xlab("Forest Code") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)
```

```{r}
#by species
res_df_plot <- res_mod_plot %>%
  filter(SPCD == 202)
res_pp_plot <- res_mod_plot %>%
  filter(SPCD == 122)
res_es_plot <- res_mod_plot %>%
  filter(SPCD == 93)

#plot
#map
ggplot(data = res_df_plot, aes(x = ppt_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Mean Annual Precipitation") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()+
  facet_wrap(~model)

ggplot(data = res_pp_plot, aes(x = ppt_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Mean Annual Precipitation") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()+
  facet_wrap(~model)

ggplot(data = res_es_plot, aes(x = ppt_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Mean Annual Precipitation") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()+
  facet_wrap(~model)

#mat
ggplot(data = res_df_plot, aes(x = tmx_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Mean Annual Max Temperature") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)

ggplot(data = res_pp_plot, aes(x = tmx_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Mean Annual Max Temperature") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)

ggplot(data = res_es_plot, aes(x = tmx_an_m,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Mean Annual Max Temperature") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)

#anomalies
#precip
ggplot(data = res_df_plot, aes(x = ppt_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Average Annual Precipitation - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()+
  facet_wrap(~model)

ggplot(data = res_pp_plot, aes(x = ppt_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Average Annual Precipitation - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()+
  facet_wrap(~model)

ggplot(data = res_es_plot, aes(x = ppt_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Average Annual Precipitation - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal()+
  facet_wrap(~model)

#temp
ggplot(data = res_df_plot, aes(x = tmx_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Average Annual Max Temperature - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)
ggplot(data = res_pp_plot, aes(x = tmx_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Average Annual Max Temperature - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)
ggplot(data = res_es_plot, aes(x = tmx_av_diff,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Average Annual Max Temperature - 30 yr Normal") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)

#density
ggplot(data = res_df_plot, aes(x = SDI_1,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Density (SDI)") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)
ggplot(data = res_pp_plot, aes(x = SDI_1,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Density (SDI)") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)
ggplot(data = res_es_plot, aes(x = SDI_1,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Density (SDI)") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)


#forest code
ggplot(data = res_pmod_plot, aes(x = FVS_LOC_CD,y = diff)) +
  geom_point(aes(color=SPCD)) +
  geom_smooth(method = 'lm',formula = y~x, se=F)+
  xlab("Forest Code") +
  ylab("Residual") +
  scale_colour_manual(values = c("202" = "purple4", "122" = "turquoise4",
                                 "93" = "gold1")) +
  theme_minimal() +
  facet_wrap(~model)
```


# Predict CR

Predict growth using annualized with tree rings only models for each species.

```{r}
pred_fan_cr <- val_an_cr(newdata = val_dset,mod_df = an_al_df, mod_pp = an_al_pp, 
                              mod_es = an_al_es,sp_stats = sp_stats,nonfocal = non_focal,
                              bratio = bratio_df ,ccf_df = ccf_df,CR_fvs_df = CR_fvs_df)
```

```{r}
pred_an_cr <- val_an_cr(newdata = val_dset,mod_df = an_red_df, mod_pp = an_red_pp, 
                              mod_es = an_red_es,sp_stats = sp_stats,nonfocal = non_focal,
                              bratio = bratio_df ,ccf_df = ccf_df,CR_fvs_df = CR_fvs_df)
```

Predict growth using annualized with tree rings and climate models for each species.

```{r}
pred_fclim_cr <- val_clim_cr(newdata = val_dset,mod_df = clim_al_df, mod_pp = clim_al_pp, 
                              mod_es = clim_al_es,sp_stats = sp_stats,nonfocal = non_focal,
                              bratio = bratio_df ,ccf_df = ccf_df,CR_fvs_df = CR_fvs_df, climate = val_clim)
```

```{r}
pred_clim_cr <- val_clim_cr(newdata = val_dset,mod_df = clim_red_df, mod_pp = clim_red_pp, 
                              mod_es = clim_red_es,sp_stats = sp_stats,nonfocal = non_focal,
                              bratio = bratio_df ,ccf_df = ccf_df,CR_fvs_df = CR_fvs_df, climate = val_clim)
```

```{r}
pred_clim_cr <- val_clim_cr(newdata = val_dset,mod_df = clim_mod_df, mod_pp = clim_mod_pp, 
                              mod_es = clim_mod_es,sp_stats = sp_stats,nonfocal = non_focal,
                              bratio = bratio_df ,ccf_df = ccf_df, climate = val_clim)
```

```{r}
pred_clim_cr <- pred_clim_cr %>%
  group_by(TRE_CN) %>%
  mutate(DG_pred = max(DIA) - min(DIA),
         DG_obs = fDIA - min(DIA))
pred_climcr2_fmy <- pred_clim_cr %>%
  filter(Year == fMEASYEAR)
par(mfrow=c(1,2))
plot(pred_climcr2_fmy$DIA,pred_climcr2_fmy$fDIA,
     xlab = "Predicted", ylab = "Observed",
     main = "DBH")
plot(pred_climcr2_fmy$DG_pred,pred_climcr2_fmy$DG_obs,
     xlab = "Predicted", ylab = "Observed",
     main = "DG")
fit_clim_cr2 <- lm(fDIA~DIA, data = pred_climcr2_fmy)
summary(fit_clim_cr2)
sqrt(mean(fit_clim_cr2$residuals^2))
fit_clim_cr2_dg <- lm(DG_obs~DG_pred, data = pred_climcr2_fmy)
summary(fit_clim_cr2_dg)
sqrt(mean(fit_clim_cr2_dg$residuals^2))
```

